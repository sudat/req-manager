# Phase 4: ヘルススコア（品質監視）チェックリスト

## 作業概要
PRD v1.3「正本のヘルススコア（2.8.1）」を実装し、正本のつながり/データ品質の欠損を可視化する。

- KISS: まずはアプリ側で算出し、DB集計/RPCは後回し
- DRY: ルール/集計/スコア算出は共通関数に寄せる
- YAGNI: 受入条件lintや suspect link など未整備データはPhase 7以降で対応

前提:
- [x] [Phase 1: DBテーブル修正（Supabase）](2026-01-19-prd-v1-3-phase1-db-schema.md) が完了している
- [x] [Phase 2: データアクセス層修正（lib/data/*）](2026-01-19-prd-v1-3-phase2-data-layer.md) が完了している
- [x] [Phase 3: 画面修正（フォーム・詳細表示）](2026-01-19-prd-v1-3-phase3-ui-forms.md) が完了している

- 戻り先: [概要計画（高レベル）](2026-01-19-prd-v1-3-schema-health-score.md)

---

## 0. スコアリング仕様の確定（重要）
- [x] 対象エンティティを確定（業務要件/システム要件/システム機能/エントリポイント/受入条件）
- [x] スコアの単位/形式を決める（0-100 / overall + per-entity）
- [x] 重要度の重み付けを決める（高/中の減点幅）
- [x] 低スコア警告の閾値を決める
  - [x] 例: エントリポイント登録率 <30% で警告
  - [x] 例: 観点種別（category）未設定率 >50% で警告
- [x] 取得できない項目の扱いを決める（suspect link/影響範囲矛盾はPhase 4で除外）

## 1. チェックルール定義（構造的なつながり）
- [x] 業務要件にシステム要件が紐づいていない（高）
  - [x] 判定元: `related_system_requirement_ids` または SR側の逆引き
- [x] システム要件に業務要件が紐づいていない（高）
  - [x] 判定元: `business_requirement_ids`
- [x] システム機能にエントリポイントが未設定（高）
  - [x] 判定元: `entry_points`（legacy `code_refs` のフォールバック可否を決める）
- [x] エントリポイントに responsibility がない（中）
- [x] 概念辞書の用語が要件文中に出現するのにリンクがない（中）
  - [x] MVPのテキストマッチ方式を決める（正規化+包含判定）
- [x] suspect link が一定期間放置（中）
  - [x] 参照フィールドの有無を確認し、Phase 4範囲に含めるか判断（データ未整備のためPhase 4では除外）
- [x] 変更要求の影響範囲と正本のつながりに矛盾（中）
  - [x] 影響範囲データの有無を確認し、Phase 4範囲に含めるか判断（変更要求と正本の連携が未実装のため除外）

## 2. チェックルール定義（データ品質）
- [x] 業務要件に `concept_ids` がない（高）
- [x] 業務要件に `impacts` がない（高）
- [x] システム要件に `category` がない（高）
- [x] 受入条件が0件（高）
  - [x] 判定元: `acceptance_criteria_json` が空、または legacy `acceptance_criteria` も空
- [x] 受入条件lint警告（高）
  - [x] Phase 4で最小導入（曖昧語の簡易lint）

## 3. スコア計算ロジック実装（共通）
- [x] スコア用モジュールの配置を決める（例: `lib/health-score/*`）
- [x] ルールごとの違反件数/率を集計する関数を実装
- [x] overall を実装（per-entityは後続）
- [x] 返却フォーマットを定義（例: `HealthScoreSummary`）
- [x] legacy互換を明示（`entry_points`/`acceptance_criteria` のフォールバック）
- [x] 代表的なダミーデータでスモーク確認（最小）

## 4. 集計データ取得（アプリ側）
- [x] ダッシュボード用に全体集計データを取得する導線を用意
- [x] 詳細画面用に対象タスク/システム機能単位の内訳を取得
- [x] 取得件数/クエリ数を確認し、必要なら絞り込みやキャッシュを検討（Phase 4は許容範囲）

## 5. UI表示
- [x] ダッシュボード（`app/dashboard/page.tsx`）に全体スコア/警告バッジを表示
- [x] タスク詳細（`app/business/[id]/tasks/[taskId]/page.tsx`）にスコア/内訳を表示
- [x] システム機能詳細（`app/system-domains/[id]/[srfId]/page.tsx`）にスコア/警告を表示
- [x] 再利用コンポーネントを追加（スコアバッジ/内訳リスト）
- [x] 警告文言/ラベルをPRDの表現に合わせる

## 6. 最小テスト
- [x] スコア関数の単体 or スモークテストを実施
- [x] UI: ダッシュボード/詳細で表示崩れがない
- [x] 低スコア時に警告が出ることを確認

---

## 完了基準（Phase 4）
- [x] PRD 2.8.1のルールに沿ったスコア算出が動作する（Phase 4範囲）
- [x] UIで全体スコア/警告/内訳が確認できる
- [x] 最小テストで破綻がない
