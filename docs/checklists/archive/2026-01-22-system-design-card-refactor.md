# システム設計カード入力構造の改善

最終更新: 2026-01-22

---

## 1. エグゼクティブサマリー（これだけ読めば分かる）

### 問題
システム設計カードが「一文メモ」になっており、コーディングエージェントが実装に必要な判断材料を得られない。

```
現状: 「ユーザー登録機能を実装する」
必要: 入力項目・バリデーション・エラー時の挙動・権限・性能条件が全て明記されている
```

### 解決策
設計カードの入力欄を構造化し、**観点別（機能/データ/例外/権限/非機能）に小項目を設けて必須入力を強制**する。

### 実装方針
- **DBスキーマ変更なし** - 既存 `system_design: jsonb` カラムの中身を拡張
- **UI変更あり** - 分類別フォームコンポーネントを追加
- **Zodスキーマ追加** - 型安全・バリデーション・lint

### 工数見積
- Phase 1（スキーマ定義）: 0.5日
- Phase 2（UIコンポーネント）: 1〜1.5日
- Phase 3（既存データ移行・表示）: 0.5日
- **合計: 2〜2.5日**

---

## 2. 問題の詳細

### 2.1 現状（Before）

`system_functions.system_design` の現在の構造:

```json
[
  { "category": "function", "title": "機能設計", "content": "ユーザー登録機能" }
]
```

**何が問題か**:
- `content` が一文の自由記述で、情報量が不足
- コーディングエージェントは「書いてないことは解釈に依存」して実装する
- 結果として誤改修・改修漏れが発生

### 2.2 なぜ問題が起きているか

| 要因 | 説明 |
|------|------|
| 入力UIが自由記述 | 何を書けばいいか分からず、浅い記述になる |
| 必須項目がない | 最低限の情報が担保されない |
| 検証がない | 曖昧な表現（「高速」「柔軟」など）が通ってしまう |

### 2.3 具体的な影響（PRD 1.1.2 参照）

> コーディングエージェントは「指示された範囲のみを精度高く実装する」。  
> 設計カードに書かれていない判断・制約・例外・境界条件は、実装に反映されないか、別の解釈で実装される。

```
例: A画面の仕様変更を指示
- 設計カードに「B(DB)→C画面の影響」が書かれていない
- コーディングエージェントはC画面を修正しない
- 本番でC画面が壊れる
```

---

## 3. 解決策

### 3.1 After の構造

`system_design` の `content` を構造化し、**対象物（何を作るか）と紐づける**:

```json
[
  {
    "category": "function",
    "title": "機能設計",
    "target": {
      "name": "発行指示画面",           // 日本語名（設計段階で入力）
      "type": "screen",                 // 種別: screen / batch / api / job / template / service
      "entryPoint": null                // 後から紐づけ（実装後にファイルパスを設定）
    },
    "content": {
      "input": "メールアドレス（必須）、パスワード（8文字以上）",
      "process": "1. メール重複チェック 2. パスワードハッシュ化 3. DBに保存",
      "output": "登録完了メッセージ、登録IDを返却",
      "sideEffects": "確認メール送信、監査ログ出力"
    }
  }
]
```

**設計→実装の流れ**:
1. **設計段階**: `target.name`（日本語）と `target.type` を入力、`entryPoint` は null
2. **実装後**: `entry_points` にファイルパスを登録し、`target.entryPoint` と紐づけ

### 3.2 各分類の構造と必須項目

#### 機能設計（function）
| キー | 必須 | 説明 |
|------|------|------|
| input | ○ | ユーザーが入力する項目と形式 |
| process | ○ | 処理の流れ（前提条件→本処理→事後条件） |
| output | ○ | 画面表示/レスポンスの内容 |
| sideEffects | - | 保存、通知、外部連携などの副作用 |

#### データ設計（data）
| キー | 必須 | 説明 |
|------|------|------|
| fields | ○ | 参照/更新する項目 |
| tables | - | 対象テーブル名 |
| constraints | - | 制約（必須、ユニーク、参照整合性） |
| migration | - | スキーマ変更が必要な場合の方針 |

#### 例外設計（exception）
| キー | 必須 | 説明 |
|------|------|------|
| errorCases | ○ | 代表的なエラーケース |
| userNotification | - | ユーザーへの通知方法 |
| logging | - | ログ出力方針 |
| recovery | - | リトライ/復旧方針 |

#### 権限設計（auth）
| キー | 必須 | 説明 |
|------|------|------|
| roles | ○ | 対象ロール |
| operations | ○ | 許可される操作 |
| boundary | - | 参照/更新の境界 |

#### 非機能設計（non_functional）
| キー | 必須 | 説明 |
|------|------|------|
| performance | - | 応答時間、スループット |
| availability | - | 可用性要件 |
| monitoring | - | 監視、監査ログ要件 |

※ 非機能は「1つ以上の入力を推奨」とし、完全な空は警告表示

---

## 4. ユーザー操作フロー

### 4.1 設計カード編集時の操作

```
1. システム機能の編集画面を開く
   /system-domains/{domainId}/{srfId}/edit

2. 「設計項目」セクションで対象物を選択（または新規作成）
   ┌───────────────────────────────────────────────────┐
   │ 対象物: [▼ 発行指示画面 (画面)              ]    │
   │         ├─ 発行指示画面 (画面)                   │
   │         ├─ PDF生成バッチ (バッチ)                │
   │         └─ ＋ 新規対象物を追加                   │
   └───────────────────────────────────────────────────┘

   ※ 新規追加時は「名前」と「種別（画面/バッチ/API等）」を入力
   ※ 実装後にエントリポイント（ファイルパス）と紐づけ可能

3. 選択した対象物に対して、観点タブを選択
   [機能] [データ] [例外] [権限] [非機能]

4. 機能タブを選択すると、以下の入力欄が表示される
   ┌─────────────────────────────────────┐
   │ 入力 *                              │
   │ ┌─────────────────────────────────┐│
   │ │（TextArea）                      ││
   │ └─────────────────────────────────┘│
   │                                     │
   │ 処理 *                              │
   │ ┌─────────────────────────────────┐│
   │ │（TextArea）                      ││
   │ └─────────────────────────────────┘│
   │                                     │
   │ 出力 *                              │
   │ ┌─────────────────────────────────┐│
   │ │（TextArea）                      ││
   │ └─────────────────────────────────┘│
   │                                     │
   │ 副作用                              │
   │ ┌─────────────────────────────────┐│
   │ │（TextArea）                      ││
   │ └─────────────────────────────────┘│
   └─────────────────────────────────────┘

5. 必須項目（*）が空のまま保存すると、バリデーションエラー

6. 曖昧語（「高速」「柔軟」など）を入力すると、警告が表示される
   ⚠ 曖昧な表現「高速」が含まれています。具体的な数値を記載してください。

7. 保存すると、構造化されたJSONとしてDBに保存
```

### 4.2 既存データの扱い

既存の一文データは以下のように自動変換される:

```json
// Before（既存データ）
{ "content": "ユーザー登録機能を実装する" }

// After（自動変換）
{ "content": { "legacy": "ユーザー登録機能を実装する" } }
```

- 編集画面では `legacy` の内容を画面上部に参考表示
- ユーザーが新しい構造に入力し直して保存することで移行完了

---

## 5. 実装計画

### Phase 1: Zodスキーマ定義（0.5日）

**ファイル**: `lib/domain/schemas/system-design.ts`

```typescript
import { z } from "zod";

// 対象物（何を作るか）
export const designTargetSchema = z.object({
  name: z.string().min(1, "対象物の名前は必須です"),
  type: z.enum(["screen", "batch", "api", "job", "template", "service"]),
  entryPoint: z.string().nullable(), // 実装後に紐づけ
});

// 各分類のcontent
export const functionDesignSchema = z.object({
  input: z.string().min(1, "入力は必須です"),
  process: z.string().min(1, "処理は必須です"),
  output: z.string().min(1, "出力は必須です"),
  sideEffects: z.string().optional(),
});

export const dataDesignSchema = z.object({
  fields: z.string().min(1, "対象項目は必須です"),
  tables: z.array(z.string()).optional(),
  constraints: z.string().optional(),
  migration: z.string().optional(),
});

// ... 他の分類も同様

// system_design 配列の1要素
export const systemDesignItemSchema = z.object({
  category: z.enum(["function", "data", "exception", "auth", "non_functional"]),
  title: z.string(),
  target: designTargetSchema,
  content: z.union([
    functionDesignSchema,
    dataDesignSchema,
    // ... 他の分類
  ]),
});
```

**作業チェックリスト**:
- [ ] `lib/domain/schemas/system-design.ts` を作成
- [ ] 5分類すべてのスキーマを定義
- [ ] TypeScript型をエクスポート（`z.infer<typeof ...>`）
- [ ] ユニットテスト追加

### Phase 2: UIコンポーネント（1〜1.5日）

**ファイル構成**:
```
components/forms/design/
├── design-target-selector.tsx    # 対象物選択・新規作成
├── system-design-editor.tsx      # メインコンポーネント（タブ切替）
├── function-design-form.tsx      # 機能設計フォーム
├── data-design-form.tsx          # データ設計フォーム
├── exception-design-form.tsx     # 例外設計フォーム
├── auth-design-form.tsx          # 権限設計フォーム
├── non-functional-design-form.tsx # 非機能設計フォーム
└── validation-summary.tsx        # 警告表示コンポーネント
```

**作業チェックリスト**:
- [ ] `DesignTargetSelector` コンポーネント作成（対象物選択・新規作成）
- [ ] `SystemDesignEditor` コンポーネント作成（タブ切替）
- [ ] 分類別フォームコンポーネント5つ作成
- [ ] 曖昧語lint機能の実装（警告表示）
- [ ] 既存の `/system-domains/{domainId}/{srfId}/edit` に組み込み
- [ ] Storybookでコンポーネント確認

### Phase 3: 既存データ移行・表示・紐づけ（0.5日）

**作業チェックリスト**:
- [ ] 読み込み時の自動変換ロジック実装（一文→ `{legacy: "..."}` ）
- [ ] 詳細画面での構造化データ表示対応
- [ ] 編集画面での `legacy` 参考表示
- [ ] 対象物と `entry_points` の紐づけUI（実装後に設定）
- [ ] E2Eテスト追加（Playwright）

---

## 6. 受入条件

### 6.1 機能要件

| # | 条件 | 検証方法 |
|---|------|----------|
| 1 | 設計カード編集画面で、対象物（画面/バッチ/API等）を選択・新規作成できる | 目視確認 |
| 2 | 選択した対象物に対して、機能/データ/例外/権限/非機能のタブが表示される | 目視確認 |
| 3 | 各タブで、該当分類の小項目（入力/処理/出力等）が入力可能 | 目視確認 |
| 4 | 必須項目が空のまま保存するとエラーが表示される | 手動テスト |
| 5 | 保存後、`system_design` カラムに `target` 含む構造化JSONが保存される | DB確認 |
| 6 | 既存の一文データを開くと、`legacy` として表示される | 目視確認 |
| 7 | 曖昧語を入力すると警告が表示される | 手動テスト |
| 8 | 実装後、対象物と `entry_points` を紐づけできる | 手動テスト |

### 6.2 非機能要件

| # | 条件 | 検証方法 |
|---|------|----------|
| 1 | フォーム入力→保存の応答時間が3秒以内 | 手動計測 |
| 2 | 既存データが破損しない（後方互換性） | 既存データのE2Eテスト |

---

## 7. リスクと対策

| リスク | 影響 | 対策 |
|--------|------|------|
| 既存データ破損 | 高 | Phase 3で自動変換ロジックを先にテスト |
| 入力負荷増大 | 中 | 必須項目を最小限に絞り、任意項目は折りたたみ表示 |
| 曖昧語lint誤検知 | 低 | 警告のみ（ブロックしない）、用語リストは段階的に調整 |

---

## 8. 未決定事項（要確認）

| # | 事項 | 選択肢 | 推奨 |
|---|------|--------|------|
| 1 | 曖昧語リストの初期セット | 「高速」「柔軟」「便利」等 | 運用しながら拡充 |
| 2 | 必須観点マトリクス | 対象物タイプ別に必須/任意を固定 | Phase 2以降で検討 |

### 確定事項

| # | 事項 | 決定内容 |
|---|------|----------|
| 1 | 「作るもの」単位での設計 | 対象物（画面/API/バッチ等）ごとに設計を記述。`target.name`（日本語）で定義し、実装後に `entry_points` と紐づけ |

---

## 9. 関連ドキュメント

- [PRD 2.7.1 エンティティ属性定義](../prd.md) - システム機能の属性定義
- [技術アーキテクチャ](../request/architecture-specification.md) - MCP連携の設計
- [旧改修計画（参考）](./2026-01-21-system-design-card-plan.md) - 詳細な背景説明

---

## 10. 変更履歴

| 日付 | 変更者 | 内容 |
|------|--------|------|
| 2026-01-22 | - | 初版作成（旧計画からの再構成） |
| 2026-01-22 | - | 「対象物」単位での設計を追加。日本語名で定義し、実装後にエントリポイントと紐づける方式に決定 |
