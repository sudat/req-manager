# Phase 6: 動作確認（E2E優先）チェックリスト

## 作業概要
Phase 1-5で導入したスキーマ拡張/互換/画面/ヘルススコアが、実データと実導線で破綻しないことをE2Eで確認する。

- KISS: まずは手動E2E（Playwright MCP）で主要導線を網羅する
- DRY: シナリオごとに「準備→操作→保存→再読込→検証→証跡」を同じ型で記録する
- YAGNI: 自動テスト/CI化は任意（手動で十分なら後回し）

## 実施結果（2026-01-19）
- 実施メモ: `.playwright-mcp/phase6-20260119-notes.md`
- 証跡: `.playwright-mcp/phase6-20260119-*.png`
- 対象ID: `BIZ-001` / `TASK-001` / `AR` / `SRF-006`（CRUD） / `SRF-001`（legacy互換）
- 注意: `bun run dev -- --port 3000` は `EADDRINUSE`（既存 `http://localhost:3000` が稼働しており継続）／SelectionDialogで a11y warning（`Missing Description or aria-describedby`）

前提:
- [x] [Phase 1: DBテーブル修正（Supabase）](2026-01-19-prd-v1-3-phase1-db-schema.md) が完了している
- [x] [Phase 2: データアクセス層修正（lib/data/*）](2026-01-19-prd-v1-3-phase2-data-layer.md) が完了している
- [x] [Phase 3: 画面修正（フォーム・詳細表示）](2026-01-19-prd-v1-3-phase3-ui-forms.md) が完了している
- [x] [Phase 4: ヘルススコア（品質監視）](2026-01-19-prd-v1-3-phase4-health-score.md) が完了している
- [x] [Phase 5: 既存データ移行・seed整備](2026-01-19-prd-v1-3-phase5-seed-mock-data.md) が完了している

- 戻り先: [概要計画（高レベル）](2026-01-19-prd-v1-3-schema-health-score.md)

---

## 0. 実行環境確認（セットアップ）
- [x] `.env` のSupabase接続/認証が有効（ログインできる）
- [x] `http://localhost:3000` でトップ/ダッシュボードが表示できる（`bun run dev -- --port 3000` は `EADDRINUSE` だったが既存サーバーが稼働）
- [x] テスト用データ方針を決める（既存データを使用）
- [x] cleanup方針を決める（破壊的な削除はせず、必要箇所のみ更新）
- [x] 再現用に対象IDを固定してメモする
  - [x] `businessId`: `BIZ-001`
  - [x] `taskId`: `TASK-001`
  - [x] `systemDomainId`: `AR`
  - [x] `srfId`（system function）: `SRF-006`（CRUD）, `SRF-001`（legacy互換）
- [x] 例外/ログ監視の方針を決める（重大なコンソール/ネットワークエラーなし。a11y warningはメモに記録）

## 1. シナリオ: 業務要件CRUD（`priority` / 受入条件）
- [x] 画面へ遷移: `/business/[id]/tasks/[taskId]/edit`
- [x] 既存を編集し、以下を更新する（対象: `BR-TASK-001-001`）
  - [x] `priority` を変更（`Could`）
  - [x] 構造化受入条件を更新（`evidence` 追記）
- [x] 保存して成功する（エラー/例外が無い）
- [x] 再読込して値が保持される（入力したpriority/受入条件）
- [x] 詳細画面: `/business/[id]/tasks/[taskId]` で表示が正しい
- [x] （任意）DB確認: `priority` / `acceptance_criteria_json` が更新されている

## 2. シナリオ: システム要件CRUD（`category` / `business_requirement_ids` / 受入条件）
- [x] 画面へ遷移: `/business/[id]/tasks/[taskId]/edit`
- [x] 既存を編集し、以下を入力する（対象: `SR-TASK-001-002`）
  - [x] `category` を変更（`auth`）
  - [x] `businessRequirementIds` を2件以上選択（同一タスク内の業務要件から）
  - [x] 構造化受入条件を1件以上入力（verification/status/evidence を埋める）
- [x] 保存して成功する（エラー/例外が無い）
- [x] 再読込して値が保持される（category/リンク/受入条件）
- [x] 詳細画面: `/business/[id]/tasks/[taskId]` で表示が正しい
  - [x] `businessRequirementIds` のリンクが存在する（存在しないIDは警告表示になる）
- [x] （任意）DB確認: `category` / `business_requirement_ids` / `acceptance_criteria_json` が更新されている

## 3. シナリオ: システム機能CRUD（`entry_points`）
- [x] 画面へ遷移: `/system-domains/[id]/[srfId]/edit`
- [x] `entry_points` を追加/編集する（対象: `SRF-006`）
  - [x] `path` を入力（例: `/ar/credit-limits/{customerId}`）
  - [x] `type` を入力（`api`）
  - [x] `responsibility` を入力（与信枠変更申請）
- [x] 保存して成功する（エラー/例外が無い）
- [x] 再読込して値が保持される（entry_points）
- [x] 詳細画面: `/system-domains/[id]/[srfId]` で表示が正しい
- [x] （任意）DB確認: `entry_points` が更新されている

## 4. シナリオ: 互換（legacyのみのデータ）
※既存データがすでにバックフィル済みで作れない場合は、Supabase側でテスト用に「片方だけ埋まっている」状態を用意する。

- [x] 業務要件: legacy `acceptance_criteria(text[])` のみでも表示できる
- [x] 業務要件: その状態で保存しても破綻しない（必要なら `acceptance_criteria_json` が同期される）
- [x] システム要件: legacy `acceptance_criteria(text[])` のみでも表示できる
- [x] システム要件: その状態で保存しても破綻しない（必要なら `acceptance_criteria_json` が同期される）
- [x] システム機能: legacy `code_refs.paths` のみでも表示できる（`entry_points` フォールバック表示）
- [x] システム機能: その状態で保存しても破綻しない（必要なら `entry_points` が同期される）

## 5. ヘルススコア/警告の整合（回帰）
- [x] ダッシュボードで全体スコア/警告が表示される（表示崩れなし）
- [x] タスク詳細で内訳が表示される（業務要件/システム要件の欠損が反映される）
- [x] システム機能詳細で内訳が表示される（entry_points欠損などが反映される）
- [x] 修正操作（entry_points追加/受入条件追加）でスコア・警告が改善する（例: タスク `78 → 86`）

## 6. 証跡（Playwright MCP）
- [x] 各シナリオで「保存前」「保存後」「再読込後」のスクショを残す（`.playwright-mcp/phase6-20260119-*.png`）
- [x] コンソールログ（エラー/警告）を記録する（再現手順含め `.playwright-mcp/phase6-20260119-notes.md` に記載）
- [x] スクショ命名を揃える（`phase6-20260119-<scenario>-<step>.png`）
- [x] 保存先を統一する（`.playwright-mcp/`）

## 7. （任意）自動化/CI（後回し可）
- [ ] PlaywrightのE2Eテストとしてシナリオ1-3の最小自動化を検討する
- [ ] CI実行の要否を判断する（YAGNI: 手動で十分なら保留）

---

## 完了基準（Phase 6）
- [x] シナリオ1-5がすべて完了し、保存→再読込で破綻しない
- [x] 互換（legacyのみ）ケースでデータ欠損が原因の例外が出ない
- [x] 主要画面で重大なコンソールエラー/ネットワークエラーが無い（a11y warningはメモ化）
- [x] 証跡（スクショ/ログ/再現手順）が揃っている
