# LLM支援型要件管理ツール 要件定義書 v1.3

- 最終更新: 2026-01-21

## 1. 目的と設計思想

### 1.1 解決する課題（本質）

本プロダクトの目的は、コーディングエージェントを前提とした大規模システム開発において、要件〜設計〜実装の情報が分断・欠落することで発生する「変更影響の漏れ」「設計漏れ」「誤改修」を実用上許容できる水準まで低減し、個人〜少人数でも開発を完遂可能にするための“正本（Single Source of Truth）”を提供することである。

本ツールが対象とするのは、ERP級（複数業務領域・多数モジュール・法対応/例外・外部連携が多い）で、変更要求が連鎖しやすいシステムである。
一方で開発体制は、コーディングエージェントの活用により「個人〜少人数でも完遂できる」ことを前提とする。
狙いは、ERP級案件としての売上規模は維持しつつ、開発メンバ削減によって開発コストを圧縮し、差分として利益を最大化できる状態を作ることにある。

従来のExcel/ドキュメント中心運用では、人間が体系全体を頭で保持し続ける必要があり、規模の増大とともに以下が致命傷になる。
- 断片的なヒアリングから要件を体系化する際の穴埋め（追加質問・提案・整合）
- 要件と設計・実装の参照関係（トレーサビリティ）の維持
- 仕様変更時の影響範囲特定（特に実装ファイル単位の漏れ）

一方で、LLMに全自動で判断を委ねると文脈誤解により誤候補が混ざりやすく、結果としてコーディングエージェントの誤改修・改修漏れを誘発する。
よって本ツールは「AIが候補生成と根拠整形を行い、人間が確定する」分業により、漏れ最小化と運用継続性を両立する。

#### 1.1.1 成功状態

コーディングエージェントによる変更適用後も、業務ユーザーが定義する業務要件（＋業務フロー）とシステム要件がシステム上で継続的に満たされ続けること。

#### 受入条件の定義

受入条件とは、上記の成功状態を保証するための検証可能な基準である。
具体的には、業務要件・業務フロー、システム要件が適切に実装されているかを判定できる条件であり、「この条件を満たさない場合、システムを本番適用できない」と判断できる基準の集合である。

#### 受入条件の粒度

受入条件は粒度を分けて保持する。
- 業務受入条件: 業務タスク単位で、業務側の期待状態（やりたいこと）を検証可能に書いた条件
- システム受入条件: システム要件単位で、機能＋データ＋例外＋権限＋非機能が業務受入条件を満たすために必要な条件

##### システム要件の分類用語定義

| 用語 | 定義 | 具体例 |
|------|------|--------|
| 機能 | システムが提供する具体的な処理・動作機能 | 仕訳登録機能、請求書出力機能、税計算API |
| データ | データ構造、データベース設計、データ整合性 | IFRS/JGAAP元帳の指定、登録データの必須チェック |
| 例外 | エラーハンドリング、異常系処理、境界値対応 | 登録前のエラーチェック、無効データの扱い |
| 権限 | アクセス制御、セキュリティ、認可 | ユーザー権限による機能制限、データアクセス制御 |
| 非機能 | 性能、可用性、保守性などの品質要件 | 処理速度3秒以内、同時アクセス対応 |

#### 受入条件の検証可能性（lint基準）

受入条件は「検証可能に書かれている」ことが必須である。本ツールは以下の基準でlintを行い、曖昧な受入条件を警告する。

| 基準 | 説明 | NG例 | OK例 |
|------|------|------|------|
| 主語・目的語・動詞が明確 | 誰が何をどうするかが特定できる | 「使いやすいこと」 | 「経理担当者が請求書PDFをダウンロードできること」 |
| 定量的または二値で判定可能 | 数値基準があるか、Yes/Noで判定できる | 「高速であること」 | 「応答時間が3秒以内であること」 |
| 判定者によって結果が変わらない | 客観的に判定できる | 「見やすいレイアウトであること」 | 「登録番号が帳票右上に印字されていること」 |

**基準判定ロジック:**  
現在は「定量的または二値で判定可能」の基準のみ自動判定を実装（曖昧用語リストによる文字比較）。他の基準は運用時の手動確認に依存する。  
lintは警告のみとし、ブロックはしない。ただし、曖昧な受入条件が残っている場合、確認結果の信頼性が低下するため、ヘルススコア（2.8.1）に反映する。

#### 受入条件の確認状態（変更要求チケットで管理）

受入条件は「検証可能に書かれている」だけでは不十分であり、「実際に検証されたか」を追跡しなければ成功状態は判定できない。

**設計原則**: 受入条件の「定義」と「確認状態」を分離する。

| 管理対象 | 保持するもの | 管理場所 |
|----------|-------------|----------|
| 受入条件定義 | description（検証可能な条件文） + verification_method（検証手段） | ベースライン仕様（業務要件・システム要件） |
| 確認状態 | status（未確認/OK/NG）+ verified_by + verified_at + evidence | 変更要求チケット |

**分離の理由**:
- 受入条件定義は不変の仕様であり、変更要求ごとに変動する確認結果を混在させるべきではない
- 改修ごとにゼロベースで確認する運用を前提とし、前回の確認結果が残存することを防ぐ
- 同一受入条件が複数の変更要求で異なる確認状態を持つことを可能にする

#### 北極星KPIの定義

「満たす」とは、**変更要求チケット単位で**、変更要求の適用後に次が同時に成立することを指す。
- 影響範囲に紐づくすべての受入条件が、**当該変更要求チケット内で**「確認済み(OK)」である

**変更要求単位での判定**:
- 変更適用前の状態に関わらず、影響範囲に含まれる要件の受入条件は再確認が必要となる
- 「未確認」の受入条件が残っている状態は判定不能である
- 「確認済み(NG)」が1件でもあれば不合格である
- 確認状態は変更要求チケットごとに独立して管理され、前回の変更要求での確認結果は引き継がない

- 北極星KPI（結果）: 変更要求適用後、影響範囲に紐づく受入条件がすべて「確認済み(OK)」であること
- 先行KPI（品質）:
  - 影響範囲の漏れ率（特に設計/ファイルレベル）を最小化（網羅性を優先）
  - 影響範囲の確信度・根拠の提示品質（レビューで確定できる状態）
  - 受入条件の確認率（未確認のまま放置されていないか）
  - 受入条件の検証可能性（lint警告の件数）

### 1.1.2 コーディングエージェントの能力仮定と本ツールの役割

本ツールは、コーディングエージェント（Claude Code等）を「指示された範囲を高精度に実装するプログラマー」と位置づける。
具体的には、以下の能力仮定を置く。

#### コーディングエージェントができること
- 明示された変更対象ファイルに対して、指示どおりの変更を高精度に実装する
- 指示に含まれる受入条件を満たすようにコードを修正する
- 指示された範囲内での整合性（型、API契約、テスト）を維持する

#### コーディングエージェントが自発的にはやらないこと
- 指示範囲外への波及影響の検出と対処
- 変更対象として明示されていないファイルの修正
- 業務要件や設計意図を踏まえた「本来直すべき範囲」の判断

なお、コーディングエージェントが実装したコードにバグが含まれる可能性はある。バグの検出は受入条件の確認フェーズで担保し、本ツールの責務はあくまで「影響範囲の漏れを防ぐこと」に限定する。

例：A画面→B(DB)→C画面の依存関係があるシステムで、A画面の仕様変更を指示した場合
- コーディングエージェントはA画面とBのスキーマ変更を精緻に実装する
- しかしB→C間の整合性（Cが参照するBのフィールド変更等）は、指示に含まれていなければ考慮しない
- 結果として、C画面で実行時エラーや表示崩れが発生する

この「波及影響の見落とし」こそが、本ツールが解決すべき中核課題である。

#### 本ツール（アプリ内AI）の責務
本ツールは、コーディングエージェントの「視野の狭さ」を補完するために、以下を担う。

1. 影響範囲の網羅的検出
   - 変更要求に対して、A-B-Cの関係性を踏まえた影響範囲を提案する
   - 人間が見落としやすい間接的な依存（B経由でCに波及）も検出する

2. 変更計画の策定
   - 影響範囲に基づき、「何を」「どの順序で」「どう直すか」の計画を生成する
   - 各変更の根拠（なぜこのファイルを直す必要があるか）を明示する

3. 実装指示パッケージの生成
   - コーディングエージェントが「指示された範囲を直せば全体整合が取れる」状態になるよう、指示を構成する
   - 指示には変更対象だけでなく、「変更してはいけない制約」「確認すべき受入条件」を含める

#### コーディングエージェントへの指示品質が成否を分ける
本ツールの価値は、コーディングエージェントに渡す指示の品質に集約される。
指示が不完全であれば、コーディングエージェントがいかに優秀でも波及影響は漏れる。

したがって、実装指示パッケージには以下を必須とする。
- 変更対象ファイルの完全なリスト（漏れがあればそのファイルは直されない）
- 各ファイルの変更意図（何を達成するための変更か）
- 影響を受ける他ファイルとの整合性制約（「このファイルを直すなら、あのファイルのこの部分も確認せよ」）
- 受入条件（業務/システム）と、どのファイルがどの受入条件に対応するか

#### 典型的な失敗の瞬間（本ツールが防ぐこと）

例：法対応（インボイス対応）として「請求書PDFに登録番号/税率別合計を追加する」変更要求が入る。

- コンサルはA:帳票テンプレート、B:請求ヘッダのDB/APIを中心に改修指示を作り、コーディングエージェントへ渡す
- コーディングエージェントは指示どおりA/Bを高精度に実装し、見える範囲のテストも通る
- しかし実際には、C:会計仕訳作成、D:外部連携CSV/EDI、E:監査ログ/帳票保全などへ波及しており、指示に含まれないC/D/Eは改修されない
- 本番の月次締め/監査対応のタイミングで「誤仕訳・突合不一致・出力不整合」が発覚し、緊急改修・手戻り・信頼毀損が発生する

破綻点は「影響範囲（特にファイル/バッチ/外部I/F）の漏れ」と、「業務受入条件が“帳票が出る”に偏り、下流（会計/監査/連携）の受入観点が抜ける」ことにある。


### 1.2 2つの管理対象（ベースライン仕様と変更要求）

本ツールは「ベースライン仕様（状態）」と「変更要求（イベント）」を分離して管理する。目的は、日常の“仕様照会”と、変更時の“影響分析〜反映”を混同しないことである。

| 区分 | ベースライン仕様 | 変更要求 |
|------|------------------|----------|
| 性質 | 状態（現行仕様の体系） | イベント（仕様変更の単位） |
| 代表的な問い | 「請求業務の仕様は？」 | 「インボイス対応で何を変える？」 |
| 主な構造 | 業務（分類）→業務タスク→業務要件→システム要件（↔ システム領域/機能） | 変更要求→影響範囲→変更内容→適用（版/コミット） |
| ゴール | 正本として参照できる体系 | 漏れのない影響分析と、受入条件を満たす変更の完遂 |

### 1.2.1 正本（Single Source of Truth）とコーディングエージェントのガードレール

本ツールは、要件・設計・受入条件・根拠・決定履歴からなる「意図の正本（Single Source of Truth）」である。
一方、実装（コード/設定/DBマイグレーション等）はリポジトリに存在する「現実の正本」である。
本ツールは現実の正本を取り込んで置き換えるのではなく、参照（リンク/パス/コミット）と根拠を保持し、「意図↔現実」の対応関係を維持する。ズレが疑われる箇所は要確認リンクとして可視化し、変更要求として収束させる。

特に変更要求フェーズでは、コーディングエージェントの「指示範囲外は見ない」特性を前提に、以下を必ず保持する。

- 影響範囲（変更対象の完全なリスト）
  - 業務要件・システム要件・システム機能・設計成果物・画面/遷移/UX仕様・ファイルを含む
  - コーディングエージェントはファイルリストに含まれないファイルを自発的に修正しない
  - 漏れは即座に波及影響の見落としにつながる
- 変更内容案（各ファイルで何をどう変えるか）
  - 変更の意図と、他ファイルとの整合性制約を含める
- 受入条件（何を満たせば完了か）
  - 変更対象ファイルと受入条件の対応関係を明示する
  - コーディングエージェントが「このファイルの変更でこの受入条件が満たされる」と認識できる状態にする
- 根拠（なぜその要件/ファイルが影響範囲に含まれるか）
  - 人間のレビュー用であると同時に、コーディングエージェントへの文脈提供にもなる

### 1.2.2 管理対象の範囲（正本として保持するもの／保持しないもの）

本ツールは「意図の正本」を保持し、「現実の正本（リポジトリ）」は参照に留める。正本の維持コストを最小化するため、保持範囲を以下のように定める。

#### Must（正本として保持）

| 対象 | 理由 |
|------|------|
| 業務要件（業務タスク単位、受入条件を含む） | コードに書いてない。業務側の意図 |
| システム要件（機能＋データ＋例外＋権限＋非機能、受入条件を含む） | 「なぜこう作ったか」はコードから読めない |
| 設計成果物（設計書）の要約・意図 | 設計判断の理由はコードに残らない |
| 概念辞書（用語・同義語・影響領域） | 業務用語とシステム用語の対応はコードにない |
| システム領域（モジュール）/ システム機能（機能カタログ） | 影響分析の観点軸 |
| エントリポイント（システム機能ごとの実装起点） | コード依存展開の入口 |
| 変更要求ごとの確定データ（影響範囲・変更内容・受入条件・根拠） | 正解データとして蓄積 |

#### Want（任意・段階導入）

| 対象 | 理由 |
|------|------|
| 画面/遷移/UX仕様 | 影響分析の精度向上に寄与 |
| 設計書の詳細本文 | 根拠提示の充実 |

#### 保持しない（コード解析で取得）

| 対象 | 理由 |
|------|------|
| ファイル間の依存関係（A imports B） | コード解析でオンデマンドに取れる。維持コストが高く陳腐化しやすい |
| コード本文 | リポジトリが正本 |
| 詳細な実装仕様 | コードを読めばわかる |

#### エントリポイントの定義

エントリポイントは「このシステム機能を触るならまずここを見ろ」という実装の起点。ディレクトリでもファイルでもよい。

| 例 | 粒度 |
|----|------|
| `/app/billing/invoice/` | ディレクトリ |
| `InvoicePdfGenerator.ts` | ファイル |
| `/app/billing/invoice/InvoicePdfGenerator.ts` | フルパス |

エントリポイントからの依存展開はコーディングエージェント（Claude Code）に委譲する。本ツールの責務は「エントリポイントまで辿り着くこと」。

### 1.3 概念辞書の作成方針

概念辞書とは、システム内の重要な用語・概念を定義し、同義語や関連するシステム領域、関連ドキュメントをまとめた辞書である。これにより、AIが要件分析や変更影響範囲の検出を行う際に、用語の曖昧さを減らし、より正確な理解を可能にする。

概念辞書の役割は「AIの誤解を減らし、影響範囲の漏れを減らす」ことである。たとえば「請求書」という用語が「Invoice」「Bill」「Statement」などの複数の表現で使われる場合、これらを概念辞書で関連付けることで、AIが変更要求を適切に分析できるようになる。

概念辞書は最初からすべてを人間が作成するのではなく、運用の中で育てていくアプローチを採用する。要件入力や変更要求の分析ごとにAIが概念候補を抽出し、人間が承認・修正・却下することで、辞書を徐々に充実させる。

運用中の重複・衝突・古くなった概念に対応するため、概念の統合・分割・廃止機能を備える。これにより、辞書の品質を継続的に維持できる。

### 1.4 AI・人間・コーディングエージェントの役割分担

| 担当 | 役割 | 具体例（A画面→B(DB)→C画面の変更） |
|------|------|----------------------------------|
| 人間 | 変更要求の起点、レビュー、最終確定 | 「A画面の表示項目を追加したい」を起票し、影響範囲候補をレビューして確定する |
| アプリ内AI | 影響範囲の検出、変更計画の策定、指示パッケージの生成 | A→B→Cの依存を分析し、「A, B, Cすべて修正が必要」と提案。各ファイルの変更内容と整合性制約を生成する |
| コーディングエージェント | 指示された範囲の精緻な実装 | 指示パッケージに従い、A, B, Cを修正する。指示に含まれていればC画面も直すが、含まれていなければ直さない |

本ツールの成否は「アプリ内AIが影響範囲を漏らさないこと」と「人間が漏れを検出できるレビュー体験を提供すること」にかかっている。
コーディングエージェントは優秀な実行者だが、指示の品質がボトルネックになる。

### 1.5 根拠提示の要件（レビューを成立させる）

AIが影響範囲や変更内容の候補を提示する場合、人間が適切にレビューできるようにするため、AIの判断根拠を明確に提示する必要がある。単に「このファイルも変更が必要」とだけ提示されても、人間は判断できないためである。

具体的には、以下の要素を根拠として提示する：

- **引用元**: どの既存要件/設計/UX仕様のどの記述にヒットしたか（引用箇所）
- **概念マッチ**: どの概念辞書エントリにマッチしたか
- **因果関係**: なぜその影響（システム領域/機能・設計成果物・ファイル）に波及するかの説明
- **追跡可能性**: 根拠から原文へ遷移できること
- **構造化データ**: 根拠と確信度を構造化データとして保持・エクスポート可能であること

これにより、人間はAIの判断が妥当かどうかを検証でき、レビューが形骸化することを防げる。

### 1.6 影響分析と要確認リンクの品質方針

本ツールの最大リスクは「漏れ」（必要な変更を見落とすこと）である。そのため、影響範囲の検出では正確性よりも網羅性を優先し、できるだけ漏れを少なくする。多少の見当違いな候補（過剰検知）が出ても構わない。その場合、AIが候補をランキング・グループ化・根拠提示することで、人間が効率的に判断できるように整理する。

また、要件・設計・UX仕様・実装などの参照先が更新された場合、関連するリンクに「要確認」の印を付ける。ただし、印が多すぎると確認作業が煩雑になるため、以下の情報を保持・表示する。
- 各リンクの最終確認日時
- 重要度（高/中/低）と表示優先順位（高を最優先）
- 一括確認画面で効率的に処理できる導線

### 1.6.1 双方向影響分析（トップダウン＋ボトムアップ）

影響分析はV字モデルに基づく双方向アプローチを採用する。まずトップダウンで、変更要求から業務要件・システム要件を経由してエントリポイントを特定し、そこからコード依存関係を展開する。一方、ボトムアップでは、特定された変更箇所から逆方向に依存関係を遡り、現実の正本における影響範囲を補完する。これにより、正本のつながりが不完全な場合でも、コード側の実装構造から影響範囲を正確に特定できる。

#### トップダウン（正本起点）
```
変更要求
  ↓ 正本で辿る
業務要件
  ↓ 正本で辿る
システム要件
  ↓ 正本で辿る
エントリポイント
  ↓ コード解析で展開
依存ファイル群
```

#### ボトムアップ（コード起点の逆流）
```
コード解析で検出した依存ファイル
  ↓ エントリポイントと突合
システム機能（正本に登録済みなら）
  ↓ 正本で逆引き
システム要件
  ↓ 正本で逆引き
業務要件
  ↓ 人間に提案
「この業務要件も影響範囲に含めますか？」
```

#### 逆流提案の例

変更要求「売上伝票計上の消費税仕訳の仕様変更」の場合：

1. トップダウンで `SR-SD-010（売上消費税仕訳）` → `/app/sd/tax-journal/` を特定
2. コード解析で `TaxJournalService.ts` が共通処理であり、仕入伝票からも呼ばれていることを検出
3. ボトムアップで `/app/mm/tax-journal/` → `SR-MM-008（仕入消費税仕訳）` → `BR-MM-001（仕入計上）` を逆引き
4. AIが提案：「消費税仕訳の共通処理を変更すると、仕入伝票計上にも影響します。SR-MM-008、BR-MM-001も影響範囲に含めますか？」

#### 逆流が機能する条件

エントリポイント → システム機能 → システム要件 → 業務要件 の逆引きができること。

正本に登録されていないエントリポイント（コード領域）は逆流が機能しない。したがって、エントリポイントの網羅性は意識的に担保する必要がある（ヘルススコアで監視）。

### 1.6.2 正解データ（評価基盤）の保持

変更要求ごとに、人間が最終確定した「影響範囲（業務要件・システム要件・システム機能・設計成果物・画面/遷移/UX仕様・ファイル）」を正解データとして保存する。
AI提案の漏れ/過検知をこの正解データで評価し、継続改善の基盤とする。

**要件区分**: 任意要件（MVPでは不要）。将来のAI精度向上のために、運用開始後に段階的に導入することを推奨する。

### 1.7 スコープ外

- テストケース管理・テスト実行管理ツールの機能はスコープ外
  - テストケースの詳細設計（手順、期待値、データ準備等）は外部ツールで行う
  - テスト実行結果の管理（パス/フェイル、実行日時、環境等）は外部ツールで行う
  - ただし、受入条件の「確認状態」と「確認根拠（外部ツールへのリンク含む）」は本ツールで追跡する
- 受入条件のlint（曖昧表現検知、検証可能性チェック、警告表示）はスコープ内
  - 「検証可能に書かれているか」のチェックは本ツールが行う
  - 「実際に検証されたか」の状態追跡も本ツールが行う
  - 「どのように検証するか」の詳細設計は外部ツールに委ねる
- 認証/権限の本格実装、組織運用（承認フローの厳格化）はモック段階では優先しない（将来拡張）

### 1.8 データ永続化（MVP段階）

- MVP段階の永続化はSupabaseを使用
- 対象テーブル
  - 業務一覧（business_domains）
  - 業務タスク（business_tasks）
  - 業務要件（business_requirements）
    - priority（優先度）を追加
    - acceptance_criteria を構造化（確認状態・検証手段・確認者・確認日時・確認根拠を含む）
    - （移行メモ）既存 `acceptance_criteria(text[])` との互換のため、MVP段階では `acceptance_criteria_json(jsonb)` を併設して段階移行する
  - システム領域マスタ（system_domains）
  - システム機能一覧（system_functions）
    - entry_points を構造化（path / type / responsibility を含む）
    - （移行メモ）既存 `code_refs.paths` から `entry_points[].path` を暫定移行する（type/responsibility は後で入力）
  - システム要件（system_requirements）
    - category（観点種別: function / data / exception / auth / non_functional）を追加
    - business_requirement_ids（紐づく業務要件ID）を追加
    - acceptance_criteria を構造化（確認状態・検証手段・確認者・確認日時・確認根拠を含む）
    - （移行メモ）既存 `acceptance_criteria(text[])` との互換のため、MVP段階では `acceptance_criteria_json(jsonb)` を併設して段階移行する
  - 概念辞書（concepts）
  - 変更要求（change_requests）
  - 影響範囲（impact_scopes：業務要件・システム要件・システム機能・設計/UX/ファイル）
  - 正解データ（impact_ground_truth：人間確定の影響範囲）
- CRUDは開発用途の匿名キーで実行（本番運用の認証は将来拡張）

---

## 2. プロダクト戦略（ユーザー価値と運用）

本章は、画面設計の前提となる「誰の、どの仕事（ジョブ）を、どの順序で、何をもって成功とするか」を定義する。

### 2.1 想定ユーザーと利用文脈

- 主要ユーザー: あなた（業務ITコンサルタント/開発責任者）
- 次期ユーザー: あなたの社員となる業務ITコンサルタント
- 利用文脈: コーディングエージェントを活用した案件開発において、ヒアリング起点で要件を体系化し、設計・実装・変更要求まで一貫して“正本”を参照して進める

本ツールが解くべき中心課題は、コーディングエージェントが開発中に必要な体系的コンテキスト（業務要件/システム要件/設計の全体整合）を把握できず、整合性を崩した実装・誤った改修をしてしまうリスクである。現状のコーディングエージェントは、プロジェクト全体の正本を十分に参照できない状態だと、局所最適の変更を積み上げて破綻しやすい。

加えて、変更要求フェーズにおいては、影響範囲の特定が不十分である場合に重大なリスクが生じる。特に、実装ファイルレベルの変更対象を正確に把握できないと、必要な改修を漏らしたり、意図しない箇所を誤って改修したりする問題が発生する。これにより、業務要件や業務フローの期待状態を定義した受入条件を満たせなくなり、システム全体の品質が損なわれる可能性がある。

#### 運用上の役割（最小）

本ツールはAIやコーディングエージェントを使うが、最終的に事故を防ぐ鍵は「誰が何を確定/確認するか」を曖昧にしないことにある。
MVPでは同一人物が兼務してよいが、将来のチーム運用を見据えて最小限の役割を定義する。

| 役割 | 責務 |
|------|------|
| 起票者 | 変更要求やヒアリング断片を起票し、背景・目的・期待・制約を残す |
| レビュア/確定者 | 影響範囲・変更内容・受入条件をレビューし、「確定」する（正本に残す） |
| 受入確認者 | 受入条件の確認（OK/NG判定）と確認根拠を残す |
| 実装者（コーディングAI） | 確定済み指示パッケージに従い実装する（指示範囲外は原則触らない） |

### 2.2 主要ユースケース（ユーザージャーニー）

本節では、フェーズごとに「クライアント／あなた（コンサル）／アプリ内AI／コーディングAI」が何を入力し、何を決め、何を成果物として残すかを定義する。

MVPでは特に、既存案件の変更要求を「壊さず通す」ためのフェーズE〜H（変更要求起票→影響分析→変更内容確定→受入→ベースライン反映）を最優先で磨く。
フェーズA〜D（新規要件の体系化〜初期実装）はプロジェクトによって必要だが、MVPでは「変更要求を回せるだけの最小の正本」を優先する。

#### 2.2.1 フェーズA: 業務要件定義

| 役割 | 主な行動 | 主要アウトプット（正本に残すもの） |
|------|----------|----------------------------------|
| クライアント | 背景・目的・現状の困りごと・例外・制約を断片的に提示（口頭含む） | ヒアリング断片、用語、例外、制約 |
| あなた（コンサル） | 断片を入力し、業務タスクへの分解方針と粒度を決める。候補をレビューして最終確定する | 業務タスク、業務要件、業務受入条件（検証可能な条件） |
| アプリ内AI | 追加質問案、穴埋め案、業務タスク分解案、業務受入条件案を根拠付きで提示する | 候補（差分）＋根拠＋確信度 |
| コーディングAI | 原則このフェーズでは実装しない（参照のみ） | - |

#### 2.2.2 フェーズB: システム要件定義

| 役割 | 主な行動 | 主要アウトプット（正本に残すもの） |
|------|----------|----------------------------------|
| クライアント | 要望（例：帳票、権限、監査、外部連携、性能）を追加提示。優先度や制約を明確化する | 制約、優先度、例外、非機能期待 |
| あなた（コンサル） | 業務要件との対応関係（なぜこのシステム要件が必要か）をレビューし、漏れがない形で確定する | システム要件、システム受入条件、業務要件↔システム要件のリンク |
| アプリ内AI | 機能/データ/例外/権限/非機能の観点で穴を検知し、受入条件案とともに候補提示する | 候補（差分）＋根拠＋確信度 |
| コーディングAI | 原則このフェーズでは実装しない（参照のみ） | - |

#### 2.2.3 フェーズC: システム設計

| 役割 | 主な行動 | 主要アウトプット（正本に残すもの） |
|------|----------|----------------------------------|
| クライアント | 画面/運用/例外時の期待（UX含む）を確認し、合意する | 画面・遷移・運用上の期待（合意点） |
| あなた（コンサル） | 要件と設計の整合をレビューし、「変更時に影響判断できる粒度」を満たすまで確定する | 設計書、画面/遷移/UX仕様、設計↔要件リンク |
| アプリ内AI | 設計の雛形や差分案、要件との矛盾・不足の指摘、根拠整形を行う | 候補（差分）＋根拠＋確信度 |
| コーディングAI | 参照のみ（この時点の設計を後工程で遵守するための理解） | - |

#### 2.2.4 フェーズD: 実装指示パッケージ作成 → コーディングAIで実装

| 役割 | 主な行動 | 主要アウトプット（正本に残すもの） |
|------|----------|----------------------------------|
| クライアント | 受入観点（ここが満たされないとNG）を最終確認する | 受入の合意（業務受入条件の確定） |
| あなた（コンサル） | 実装方針・優先度・リスクを確定し、指示パッケージを最終確定する | コーディングAI向け指示（確定版） |
| アプリ内AI | コーディングAIが道を外れないための情報を機械可読に出力する | 実装指示パッケージ（下記） |
| コーディングAI | 指示パッケージを参照して実装し、受入条件を満たすよう修正する | 実装変更（PR/コミット）、変更ファイル、実装メモ |

実装指示パッケージに含めるべき最小要素は次のとおり。
- 変更対象ファイル候補（パス）と優先度
- 変更内容案（差分の意図、制約、禁止事項）
- 受入条件（業務/システム。何がOKなら完了か）
- 根拠（要件・設計・UX仕様への参照）
- 全体整合のための前提（用語、制約、非機能、例外、関連する設計判断）

#### 2.2.5 フェーズE: 変更要求の起票（何を変えたいかの確定）

| 役割 | 主な行動 | 主要アウトプット（正本に残すもの） |
|------|----------|----------------------------------|
| クライアント | 追加/変更したい業務要件・運用・制約を提示する（背景/目的/期待を含む） | 変更要求（背景/目的/期待）、関連するヒアリング断片 |
| あなた（コンサル） | 変更要求のスコープと優先度を整理し、受入条件（業務側の期待）を更新・確定する | 更新された業務受入条件、変更要求のスコープ（暫定） |
| アプリ内AI | 不足情報を指摘し、追加質問案と「変更要求により追加/更新される受入条件案」を根拠付きで提示する | 追加質問案、受入条件案（差分）＋根拠＋確信度 |
| コーディングAI | 原則このフェーズでは実装しない（参照のみ） | - |

#### 2.2.6 フェーズF: 影響分析（影響範囲の確定＝正解データ化）

| 役割 | 主な行動 | 主要アウトプット（正本に残すもの） |
|------|----------|----------------------------------|
| クライアント | 影響がありそうな業務・画面・例外の観点を補足する（あれば） | 影響観点の補足 |
| あなた（コンサル） | 影響範囲（システム領域/機能・要件・設計・画面/UX・ファイル）を最終確定する（＝正解データ） | 影響範囲（正解データ）、影響理由（根拠） |
| アプリ内AI | 網羅性を優先して影響範囲候補を提示し、根拠（引用＋因果）と確信度、候補のクラスタリング/優先度付けを行う | 影響範囲候補＋根拠＋確信度（差分提案） |
| コーディングAI | 原則このフェーズでは実装しない（参照のみ） | - |

#### 2.2.7 フェーズG: 変更内容の確定 → 実装指示パッケージ作成 → コーディングAIで改修

| 役割 | 主な行動 | 主要アウトプット（正本に残すもの） |
|------|----------|----------------------------------|
| クライアント | 期待する振る舞い/画面/例外の最終確認（必要なら） | 期待の最終合意 |
| あなた（コンサル） | 変更内容（何をどう変えるか）と受入条件を最終確定し、指示パッケージを確定する | 変更内容（確定版）、指示パッケージ（確定版） |
| アプリ内AI | 影響範囲（正解）に基づき、変更内容案とコーディングAI向け指示パッケージを生成する（整合前提を明示） | 変更内容案＋根拠、指示パッケージ案 |
| コーディングAI | 指示パッケージに従って改修し、受入条件を満たすよう修正する | 実装変更（PR/コミット）、変更ファイル、実装メモ |

#### 実装指示パッケージの検証観点

指示パッケージの品質がコーディングエージェントの実装品質を決める。人間が確定前にチェックすべき項目は以下。

| 検証観点 | チェック内容 | 不備時のリスク |
|---------|-------------|---------------|
| 影響範囲の網羅性 | 影響範囲に含まれるすべてのファイルが、変更対象として指示に含まれているか | 漏れたファイルは修正されない |
| 受入条件との紐づけ | 各ファイルの変更意図が、対応する受入条件と紐づいているか | 何のための変更かが不明確になる |
| 整合性制約の明示 | 依存関係のあるファイル間で、整合性制約が明示されているか（「Bを変えるならCのここも確認」） | 整合性が崩れる |
| 禁止事項の明示 | 変更してはいけない制約（既存機能への影響回避）が明示されているか | 意図しない副作用 |
| 逆流提案の反映 | ボトムアップで検出された追加影響が、指示に含まれているか | 共通処理の変更が下流に波及しない |

これらが欠けた指示パッケージは、コーディングエージェントの実装品質に関わらず波及影響を見落とす。

#### 2.2.8 フェーズH: 受入（受入条件ベース）→ ベースライン反映 → 要確認消化

| 役割 | 主な行動 | 主要アウトプット（正本に残すもの） |
|------|----------|----------------------------------|
| クライアント | 受入条件に基づいて受入可否を判断する（またはあなたが代理で確認する） | 受入条件ごとの確認結果（OK/NG）と確認根拠 |
| あなた（コンサル） | すべての受入条件が「確認済み」になったことを確認し、ベースライン（版）への適用を確定する。NGがあれば差し戻す。必要に応じて要確認リンクを消化する | 版適用履歴、要確認消化履歴 |
| アプリ内AI | 未確認の受入条件を警告表示し、確認漏れを防ぐ。要確認リンクの優先度付けと一括確認導線を提示する | 未確認リスト、要確認の優先リスト |
| コーディングAI | NGが残る場合のみ追加改修する | 追加実装変更 |

受入の完了条件:
- 影響範囲に紐づくすべての受入条件が「確認済み」である（未確認がゼロ）
- 確認済みの受入条件がすべてOKである（NGがゼロ）
- 上記2条件を満たした状態で、ベースライン（版）への適用が確定されている

未確認の受入条件が残っている状態でベースライン反映を試みた場合、本ツールは警告を表示する（MVP段階では警告のみ、強制ブロックはしない）。

### 2.3 価値仮説（なぜこのプロダクトが必要か）

- 正本の一元化: 要件・設計・UX仕様・実装参照を一貫した構造で保持し、参照先の分断をなくす
- 漏れ最小化: 影響分析は網羅性を優先とし、根拠提示とレビューにより現実的に運用可能な形へ落とし込む
- 継続改善: 変更要求ごとに人間が確定した影響範囲を正解データとして保持し、AI提案の品質を定量評価できる状態を作る

Notion/Excel/Jira等でも業務要件・システム要件・システム設計は管理できるが、これら製品では「コーディングエージェントが誤改修しないために必要な、影響範囲（ファイル含む）・根拠・受入条件の確認状態」を一貫した構造で保持しづらく、またAIで影響調査する専用機能を持たない。
本ツールは変更要求を中心に、確定データと根拠を蓄積し、コーディングエージェントへ正確な影響調査をもとにした改修対象範囲・修正内容を出力できることを差別化ポイントとする。

### 2.3.1 検証すべき前提（リスクと検証方針）

本プロダクトの価値仮説は、以下の前提が成立することに依存している。MVPでは実案件を通じてこれらを検証し、成立しない場合は設計を見直す。

#### 前提1：正本維持のコストがペイする

正本（業務要件・システム要件・エントリポイント・概念辞書）を維持するコストが、コーディングエージェントの誤改修を防いだことによる削減工数を下回る必要がある。

| 検証指標 | 目標 |
|---------|------|
| 正本整備の初期コスト | 変更要求を回せる最小限の正本整備に要する時間 |
| 正本維持の継続コスト | 変更要求1件あたりの正本更新時間（要確認消化含む） |
| 削減効果 | 誤改修・手戻りの発生率と修正コスト |

検証方針：最初の実案件で上記を計測し、コスト対便益が成立しない場合は正本の範囲を縮小する。

#### 前提2：コールドスタート問題を乗り越えられる

「正本がない状態から変更要求を回せる」設計が必要。全体を整備してから始めるのではなく、変更要求を回しながら正本を育てる。

検証方針：正本がほぼ空の状態から変更要求を起票し、影響分析→正本追加→次の変更要求という「育成ループ」が実際に回るかを検証する。

#### 前提3：AI影響分析の精度が運用に耐える

影響分析の過検知率が高すぎるとレビュー疲れで形骸化する。

| 検証指標 | 目標（暫定） |
|---------|-------------|
| 過検知率 | 影響候補のうち、実際には不要だったものが50%以下 |
| 漏れ率 | 人間が確定した影響範囲のうち、AIが提案しなかったものが10%以下 |

検証方針：変更要求ごとに正解データ（人間確定の影響範囲）を蓄積し、AI提案との差分を計測する。過検知率が高い初期段階では、クラスタリングと優先度付けでレビュー負荷を下げる。

#### 前提4：コーディングエージェントの能力仮定が維持される

本ツールは「コーディングエージェントは指示範囲外を自発的に見ない」という前提に立っている。この前提が崩れた場合（コーディングエージェントが自律的に波及影響を検出できるようになった場合）、本ツールの役割は「影響検出」から「業務文脈の正本管理」にシフトする。

検証方針：コーディングエージェントの進化を継続的にウォッチし、能力仮定を半年ごとに見直す。

### 2.4 MVPスコープ（段階導入）

MVPの勝ち筋は、既存案件の変更要求を「壊さず通す」こと（フェーズE〜H）で価値を立証することである。よってMVPは変更要求中心に構成する。

- MVPで必ず提供すること
  - 変更要求の起票〜影響分析〜変更確定〜受入（確認状態/根拠）〜ベースライン反映（版）までの運用
  - 影響範囲の提案と確定（システム領域/機能・要件・設計/UX・ファイル）およびコーディングエージェント向け出力
  - 正解データ（人間確定の影響範囲）の保存
  - 最小限の正本整備: 変更要求を回すために必要な範囲で、業務要件/システム要件・設計/UX仕様を保持できる

- MVPでは優先しないこと
  - 既存Excelの取り込み（B）
  - テスト管理（テストケース/実行結果の追跡）
  - 本番運用向けの厳格な認証/権限/承認フロー

### 2.5 成功指標（運用での判定）

本ツールの成功は、単なる画面の完成ではなく、実プロジェクトで次が成立することによって判定する。

- 変更要求適用後、影響範囲に紐づく受入条件がすべて「確認済み(OK)」である

上記のために、変更要求ごとに「影響範囲の最終確定」と「受入条件の確定」を必須の運用ゲートとする。

### 2.6 前提・制約（MVPの意思決定）

本プロダクトは「要件の百科事典」を目指す前に、まず「変更要求で壊さない」ことに集中する。そのため、MVPでは次を前提とする。

- 利用単位: 1プロジェクト（=1案件/1プロダクト）を基本とし、プロジェクト横断（複数案件の同居）はMVPでは扱わない
- 利用者: 個人〜少人数を主対象とし、厳格な権限分離や承認フローは将来拡張とする
- 正本の境界: 「意図の正本」は本ツールで確定したもののみ正とする（外部ツール/リポジトリは参照先＝現実の正本）。意図と現実の差分は要確認リンクと変更要求で管理し、確定情報は本ツールへ戻す
- 機密性: 顧客情報を含む可能性があるため、LLMへ送信する入力範囲はユーザーが可視化・制御できることを前提とする（少なくとも「どの原文を根拠として送るか」を表示）
- 既存ツール連携: GitHub/Notion等との自動連携は段階導入とし、MVPはURL/パス/メモの手入力でも成立することを優先する

### 2.7 用語定義（最低限）

本PRDでは「領域」「要件」「機能」という言葉が混同しやすいため、以降は次の用語で区別する。

| 用語 | 定義 | 例 |
|------|------|----|
| 業務（分類） | 業務上の分類ラベル。業務タスクの束ね方 | 請求、入金消込、購買 |
| 業務タスク | 業務側のジョブ単位。業務要件の束ね方 | 請求書発行、売上計上 |
| 業務要件 | 業務タスクを成立させる要件。業務受入条件を含む | 「請求書をPDFで出力できる」 |
| システム領域 | システム側のモジュール/責務境界 | SD請求、FI会計、認証 |
| システム機能 | システム領域内の機能カタログ。人間が認識しやすい機能単位（画面/バッチ/API等）であり、システム要件の親となる | 仕訳登録画面、請求書出力バッチ、税計算API |
| システム要件 | システム機能を成立させる個々の要件。機能＋データ＋例外＋権限＋非機能を含む。1つ以上の業務要件に紐づく | 「仕訳登録時にIFRS/JGAAPの元帳を指定できる」「登録前にエラーチェックが走る」 |
| 変更要求 | 仕様変更の単位（イベント）。影響範囲・変更内容・受入条件・根拠を確定する対象 | 「インボイス対応」 |
| 影響範囲 | 変更要求が波及する対象の集合。業務要件・システム要件・システム機能・設計成果物・画面/遷移/UX仕様・ファイルを含む | 「BR-BIL-001, SR-BIL-002, SF-BIL-010, /app/billing/*」 |
| 受入条件 | 要件（業務/システム）が満たされているかを判定するための、検証可能な条件 | 「請求書PDFに登録番号が印字されていること」 |
| 受入条件確認 | 変更要求チケット内で、特定の受入条件の検証結果を管理するもの。status（未確認/確認済みOK/確認済みNG）・verified_by（確認者）・verified_at（確認日時）・evidence（確認根拠）を持つ。変更要求ごとに独立した版管理を行う | 「CR-001でAC-001が確認済みOK」「CR-002で同じAC-001が未確認」 |
| 根拠（evidence） | 候補提示の出典と推論（引用箇所、概念ヒット、因果）を構造化したもの | 要件IDと該当スパン |
| 要確認リンク | 更新により再確認が必要になったリンク。重大度（高/中/低）を持つ | 「要件A更新→要件Bが要再確認」 |

#### データ構造上の親子関係

本ツールのデータ構造は以下の親子関係を持つ。

業務（分類）
└─ 業務タスク
└─ 業務要件（業務受入条件を含む）
└─ [リンク] システム要件システム領域
└─ システム機能（親）
└─ システム要件（システム受入条件を含む）
└─ [リンク] 業務要件

システム要件は「システム機能の配下」に属し、かつ「1つ以上の業務要件にリンク」する。これにより、業務要件→システム要件→システム機能の双方向トレーサビリティを実現する。

### 2.7.1 エンティティ属性定義

本節では、各エンティティの属性、粒度判断基準、十分性基準を定義する。
これらは影響分析の精度に直結するため、データ登録時に遵守する。

#### 業務タスク（business_tasks）

| 属性 | 必須 | 説明 |
|------|------|------|
| id | ○ | 一意識別子（TASK-XXX） |
| business_id | ○ | 所属する業務分類 |
| name | ○ | タスク名（20字以内） |
| summary | ○ | 業務概要＋業務フロー（Markdown、200〜500字目安） |
| person | ○ | 主担当者（ロール名） |
| input | ○ | 業務のインプット（カンマ区切り） |
| output | ○ | 業務のアウトプット（カンマ区切り） |

##### 粒度判断基準

以下のいずれかが異なれば、業務タスクを分割する。

- 担当者（ロール）が異なる
- 実行タイミング（日次/月次/随時）が異なる
- インプットまたはアウトプットが独立している

##### 十分性基準

「この業務タスクの記述だけで、関連するシステム機能を特定できるか」を自問する。
業務フローに登場するシステム操作（画面操作、帳票出力、バッチ実行等）が明記されていれば十分。

---

#### 業務要件（business_requirements）

| 属性 | 必須 | 説明 |
|------|------|------|
| id | ○ | 一意識別子（BR-XXX-XXX） |
| task_id | ○ | 所属する業務タスク |
| title | ○ | 要件名（「〜できること」形式、30字以内） |
| summary | ○ | 要件の詳細（100〜200字） |
| priority | ○ | 優先度（Must / Should / Could） |
| concept_ids | ○ | 関連する概念辞書のID（1件以上推奨） |
| impacts | ○ | 影響するシステム領域（1件以上推奨） |
| acceptance_criteria | ○ | 受入条件（構造化形式、1件以上必須） |
| related_system_requirement_ids | - | 紐づくシステム要件ID（業務要件側から選択可能。保存時にシステム要件のbusiness_requirement_idsと双方向同期） |

##### 粒度判断基準

以下を満たす単位で分割する。

- 1つの受入条件セットで検証できる範囲
- 独立して「満たす/満たさない」を判定できる単位

##### 十分性基準

concept_ids と impacts が空の場合、影響分析のマッチングが効かない。
登録時に空の場合は警告を表示する（ブロックはしない）。

---

#### システム機能（system_functions）

| 属性 | 必須 | 説明 |
|------|------|------|
| id | ○ | 一意識別子（SRF-XXX） |
| system_domain_id | ○ | 所属するシステム領域 |
| title | ○ | 機能名（30字以内） |
| category | ○ | 機能種別（screen / batch / api / job / interface） |
| summary | ○ | 機能概要（200字程度） |
| status | ○ | 実装状態（not_implemented / implementing / testing / implemented） |
| entry_points | ○ | エントリポイント群（構造化形式、1件以上必須） |
| system_design | - | 設計項目（JSONB） |

##### エントリポイントの構造

システム機能は業務単位で管理し、エントリポイントに種別と責務を持たせる。
影響分析の絞り込みはエントリポイントの type と responsibility で行う。

（DB表現）entry_points は jsonb の配列として保持する（default `[]`）。
```json
[
  {
    "path": "/app/billing/invoice/page.tsx",
    "type": "screen",
    "responsibility": "発行指示、一覧表示"
  },
  {
    "path": "/jobs/invoice-pdf-batch.ts",
    "type": "batch",
    "responsibility": "PDF生成、税計算、登録番号出力"
  }
]
```

| 属性 | 必須 | 説明 |
|------|------|------|
| path | ○ | リポジトリ内のファイルパス |
| type | ○ | 種別（screen / batch / api / job / template / service） |
| responsibility | ○ | このエントリポイントが担う処理（20字程度） |

（MVP移行メモ）Phase 1の暫定移行では `code_refs.paths` から `entry_points[].path` のみを移行するため、`type` / `responsibility` が未入力（null/空）になりうる。
後続フェーズ（Phase 3）で入力UIを追加し、ヘルススコア（2.8.1）で欠損を可視化する。

##### 粒度判断基準

システム機能は業務単位で管理する（画面/バッチ/APIごとに分割しない）。

分割が必要なケース：
- 業務上の意味が異なる（例：請求書発行 vs 請求書照会）
- 変更要求の影響が独立している

##### 十分性基準

entry_points が空、または responsibility が未記入の場合、影響分析の絞り込みが効かない。
登録時に警告を表示する。

---

#### システム要件（system_requirements）

| 属性 | 必須 | 説明 |
|------|------|------|
| id | ○ | 一意識別子（SR-XXX-XXX） |
| srf_id | ○ | 所属するシステム機能 |
| task_id | - | 関連する業務タスク（逆引き用） |
| category | ○ | 観点種別（function / data / exception / auth / non_functional） |
| title | ○ | 要件名（「〜できること」形式、30字以内） |
| summary | ○ | 要件の詳細（100〜200字） |
| concept_ids | ○ | 関連する概念辞書のID |
| impacts | ○ | 影響するシステム領域 |
| acceptance_criteria | ○ | 受入条件（構造化形式、1件以上必須） |
| business_requirement_ids | ○ | 紐づく業務要件ID（1件以上必須） |

##### 観点種別（category）の定義

| 種別 | 説明 | 記載内容 |
|------|------|---------|
| function | 何ができるか | システムの振る舞い。「〜できること」 |
| data | 何を扱うか | 入出力データの項目、形式、制約、計算ルール |
| exception | 異常時にどう振る舞うか | エラー、警告、境界条件、リカバリ |
| auth | 誰が使えるか | ロール、承認、操作制限 |
| non_functional | どのくらいの品質か | 性能、可用性、保守性、セキュリティ |

##### 粒度判断基準

1つのシステム機能に対して、観点種別ごとに要件を洗い出す。
観点が混在した要件は分割する。

##### 十分性基準

business_requirement_ids が空の場合、「なぜこのシステム要件が必要か」が不明になる。
登録時に空の場合は警告を表示する。

新規登録時、AIが「この機能要件に対応する例外要件はありますか？」と促す。

---

#### 受入条件の構造（共通）

業務要件・システム要件の acceptance_criteria は「オブジェクト配列」として保持する。

（MVP実装メモ）既存互換のため、DBには legacy `acceptance_criteria: text[]` を残し、構造化版は `acceptance_criteria_json: jsonb`（配列、default `[]`）に保持する。
アプリ側は `acceptance_criteria_json` を優先して読み取り、更新時は両方を同期する（KISS）。

（DB表現）acceptance_criteria_json は jsonb の配列として保持する（default `[]`）。
```json
[
  {
    "id": "AC-001",
    "description": "請求書に登録番号が表示されること",
    "verification_method": "目視確認"
  }
]
```

| 属性 | 必須 | 説明 |
|------|------|------|
| id | ○ | 受入条件ID（親ID-AC-連番） |
| description | ○ | 検証可能な条件文 |
| verification_method | ○ | 検証手段（目視確認 / 自動テスト / 外部ツール参照） |

（MVP移行メモ）既存の `acceptance_criteria(text[])` からの暫定移行では、まず description を埋めて `verification_method` は未入力（null）として開始してよい。
**確認状態（status/verified_*）は変更要求チケット機能で管理するため、受入条件定義からは除外する。**

---

#### 概念辞書（concepts）

| 属性 | 必須 | 説明 |
|------|------|------|
| id | ○ | 一意識別子（C-XXX） |
| name | ○ | 概念名（正式名称） |
| synonyms | ○ | 同義語・別名（配列、1件以上推奨） |
| areas | ○ | 影響するシステム領域（配列、1件以上必須） |
| definition | ○ | 定義（Markdown、要件・ルール・関連法令を含む） |
| related_docs | - | 必読ドキュメントのパス |

##### 十分性基準

synonyms が空だと、自然言語での検索やマッチングが効きにくい。
業務用語とシステム用語の両方を登録することを推奨。

### 2.8 運用フロー（ゲートと状態遷移）

LLM候補生成を「思考」ではなく「差分提案」として運用に落とすため、MVPでは次のゲートを置く。

- AIが生成するものは常に「候補」であり、確定は必ず人間が行う
- 「確定」された要素のみがエクスポート対象（コーディングエージェントに渡す正本）となる
- 変更要求の最小完了条件は次の同時成立
  - 影響範囲（正解データ）が確定している
  - 変更内容が確定している
  - 変更要求に紐づく受入条件が確定している
  - 影響範囲に紐づくすべての受入条件が「確認済み」である（未確認がゼロ）
  - 受入条件ベースで受入OKになっている（確認済み(NG)がゼロ）
  - ベースライン（版）へ適用済である（適用履歴が残る）
- 要確認リンク（重大度：高/中）は放置すると正本の信頼性が崩壊するため、「次の変更要求を開始する前に消化する」運用を推奨する（MVPでは強制はしない）

### 2.8.1 正本のヘルススコア（品質監視）

正本のつながりが不完全だと影響分析の精度が落ちる。以下を自動検出し、ダッシュボードに表示する。

#### 構造的なつながりのチェック

| チェック項目 | 重要度 | 検出方法 |
|-------------|-------|---------|
| 業務要件にシステム要件が紐づいていない | 高 | related_system_requirement_ids が空 |
| システム要件に業務要件が紐づいていない | 高 | business_requirement_ids が空 |
| システム機能にエントリポイントが未設定 | 高 | entry_points が空 |
| エントリポイントに responsibility がない | 中 | responsibility が null または空文字 |
| 概念辞書の用語が要件文中に出現するのにリンクがない | 中 | テキストマッチ |
| 要確認リンクが一定期間放置されている | 中 | 最終確認日時 |
| 変更要求で確定した影響範囲と、正本上のつながりに矛盾がある | 中 | 差分検出 |

#### データ品質のチェック

| チェック項目 | 重要度 | 検出方法 |
|-------------|-------|---------|
| 業務要件に concept_ids がない | 高 | 配列が空 |
| 業務要件に impacts がない | 高 | 配列が空 |
| システム要件に category（観点種別）がない | 高 | null または未設定 |
| 受入条件が0件 | 高 | acceptance_criteria_json が空（legacy互換の場合は acceptance_criteria も考慮） |
| 受入条件がlint警告を受けている（検証可能性が低い） | 高 | lint結果 |

ヘルススコアは「正本の信頼性」を可視化するものであり、100%を目指すものではない。変更要求を回しながら徐々に改善する。

なお、ヘルススコアが著しく低い状態（エントリポイント登録率30%未満、観点種別未設定率50%超など）で影響分析を実行した場合、本ツールは「影響分析の精度が低下している可能性があります」と警告を表示する。

### 2.8.2 変更要求起点の正本育成フロー

正本は最初から完璧に整備するのではなく、変更要求を回しながら育てる。
```
変更要求「インボイス対応」
  ↓
影響分析（トップダウン）
  → 正本に登録されていないシステム機能を発見
  → 「このエントリポイントをシステム機能として登録しますか？」
  ↓
影響分析（ボトムアップ・逆流）
  → 正本にないつながりを発見
  → 「このシステム要件と業務要件をリンクしますか？」
  ↓
影響範囲の確定
  → 確定した影響範囲を正解データとして保存
  → 正本のつながりを更新（オプション）
  ↓
次の変更要求
  → 前回の学習が活きる
```

この「育成ループ」により、変更要求を回すほど正本が充実し、影響分析の精度が上がる。

### 2.9 非機能・品質要件（MVP）

- 根拠がない候補は出さない: 根拠が不足する場合は「不足情報」と「追加質問」を提示する
- レビューが成立すること: 候補提示は「一括で確定/却下できる粒度」とし、過検知を許容してもレビュー作業が破綻しないUIを優先する
- 変更要求あたりのレビュー時間の目安: 影響範囲の確定まで30〜60分で回ること（回らない場合は表示/クラスタリング/既定フィルタを改善する）
- 監査性: 「誰が・いつ・何を確定したか」を最低限追える（個人利用でも、後から自分が再現できることが重要）
- 性能（目標）: 照会検索の初回結果が3秒以内に表示される（再ランキングや詳細根拠は遅延ロード可）

### 2.10 主要リスクと対策方針

| リスク | 具体例 | 対策方針 |
|--------|--------|----------|
| 過検知によるレビュー疲れ | 影響候補が多すぎて確定できない | 重大度/確信度/クラスタリングで「まず見るべき」を絞る。既定フィルタで高重要度を先に出す |
| 漏れの見逃し | AI提案に含まれない影響が出る | 正解データを蓄積し、漏れを検知して改善する（1.6.1）/ 影響分析は網羅性を優先（1.6） |
| 正本の陳腐化 | 更新が反映されず形骸化する | 要確認リンク運用を前提にし、高/中だけを可視化・一括消化できる導線を用意する |
| 用語/領域の混同 | 業務領域とシステム領域が混ざり、検索/影響分析が崩れる | 用語定義を固定（2.7）。UI/データで明示的に区別し、ID体系も分ける |
| 機密情報の取り扱い | 顧客固有情報がLLMに送られる/ログに残る | 送信対象の可視化と最小化を前提に設計（2.6）。必要に応じて伏字/要約モードを用意する |

---

## 3. 画面構成（MVP / 現行Next.js実装準拠）

本章は、2章までの方針（変更要求を壊さず通す＝フェーズE〜H優先）を前提にしつつ、現行Next.js実装（ルーティング/画面）に合わせて画面構成を整理する。
ただし現状では、変更要求と版管理は「UIは存在するが運用できる状態ではない」ため、当面は提供中/準備中を明確に分け、誤解や運用崩壊（正本の信頼性低下）を防ぐ。

### 3.1 共通レイアウトとナビゲーション

全画面で共通のサイドメニュー（PC）と、モバイル用ヘッダー＋スライドメニュー（SP）を使用する。
設定画面は設定専用の左メニュー（設定サブナビ）を持つ。

| 区分 | メニュー | ルート | 目的 | 提供状態（現行） |
|------|----------|--------|------|----------------|
| 主要 | ダッシュボード | `/dashboard` | 状況把握と「次にやること」の起点 | サンプル（準備中） |
| 主要 | 照会 | `/query` | 自然言語で横断的に探す（探索コスト削減） | サンプル（準備中） |
| 主要 | 業務一覧 | `/business` | 意図の正本の入口（業務→タスク→要件） | 提供中 |
| 主要 | 変更要求一覧 | `/tickets` | 変更要求（イベント）の入口（フェーズE〜H） | 提供中（DB連携・受入条件確認） |
| 主要 | ベースライン履歴 | `/baseline` | 版の参照（将来：版間差分/適用履歴） | 準備中（UIのみ） |
| 主要 | エクスポート | `/export` | 外部出力（将来：Claude Code連携。詳細は5章） | 準備中（UIのみ） |
| 管理 | 概念辞書 | `/ideas` | 概念（用語/同義語/影響領域）を育て、影響分析の精度を上げる | 提供中 |
| 管理 | システム領域一覧 | `/system-domains` | システム領域/機能カタログ（影響分析の観点軸） | 提供中 |
| 管理 | 設定 | `/settings` | プロジェクト/LLM等の設定 | 部分提供（設定の一部は将来） |

補足（KISS）: 本ツールは正本の信頼性が価値の中心であるため、「準備中（UIのみ）」はサイドメニューから非表示、または「準備中」ラベル付きで無効化する運用を推奨する。

設定サブナビ（`/settings/*`）:
- プロジェクト設定: `/settings`
- LLM設定: `/settings/llm`
- 通知設定: `/settings/notification`

### 3.2 フェーズ別主要導線（現行→勝ち筋へ）

勝ち筋は、既存案件の変更要求を「壊さず通す」ためのフェーズE〜Hである。
一方で現行実装は、E〜Hを成立させる前提（意図の正本の整備）に比重がある。
よって、フェーズ1（提供中）→フェーズ2（準備中）として導線を分ける。

#### 3.2.1 フェーズ1（提供中）: 意図の正本を整備する

目的は、フェーズ2の影響分析・レビュー・受入を成立させるための「参照可能な正本」を最小コストで整えること。

- 業務/タスク/要件の整備: `/business` → `/business/{bizId}/tasks` → `/business/{bizId}/tasks/{taskId}/edit`
  - 業務要件/システム要件に受入条件を記述し、概念・システム領域/機能と紐づける
- システム領域/機能カタログの整備: `/system-domains` → `/system-domains/create` → `/system-domains/{systemDomainId}/create`
  - 機能単位で、設計項目やコード参照（パス）を保持できるようにする
- 概念辞書の整備: `/ideas`
  - 同義語と影響領域を育て、後工程の影響分析の漏れを減らす（1.3）

#### 3.2.2 フェーズ2（部分提供中）: 変更要求を壊さず通す（E〜H）

> **2026-01-21更新**: Phase 5.7完了により、影響範囲選択UI・確定UI・北極星KPI達成状況表示が実装済み。影響分析（AI自動抽出）は将来実装予定。

最初の薄いスライスは「手動でも成立する」ことを優先する（YAGNI）。AI影響分析や自動差分は後追いでよい。

- フェーズE（起票）: `/tickets/create` **[提供中]**
  - 背景/目的/期待、優先度、担当者を入力して変更要求を起票する（DB永続化済み・自動採番）
- フェーズF（影響範囲の確定）: `/tickets/{id}` **[提供中]**
  - 影響範囲選択UI（業務要件・システム要件の階層選択）が実装済み
  - 確定ボタンで影響範囲をconfirmed状態に変更可能（confirmed_by/confirmed_atを記録）
  - 確定済みは編集不可にする機能が実装済み
  - 確認済み率の計算・表示、北極星KPI達成フラグの表示が実装済み
  - AIは候補提示に留め、根拠がない候補は出さない（2.9）
- フェーズG（変更内容の確定→指示パッケージ化）: `/tickets/{id}` / `/tickets/{id}/edit` **[提供中]**
  - 基本情報の編集・ステータス/優先度変更が可能（DB永続化済み）
- フェーズH（受入→版反映）: `/tickets/{id}` を中心に実現する **[部分提供]**
  - 受入条件確認状態の更新（未確認/OK/NG）・確認者・根拠の記録が可能
  - 一括確認機能により複数項目を効率的に確認可能
  - 北極星KPI達成状況（全確認済みOK）の表示が実装済み
  - 版適用の実処理/履歴は将来実装

### 3.3 正本（意図の正本）メンテナンス（ベースライン仕様）

変更要求の影響分析を成立させるために、最小限の「意図の正本（要件・設計・受入条件・根拠）」を整備する。

#### 3.3.1 業務→タスク→要件（業務中心）

- 業務一覧: `/business`（作成/編集/削除）
- 業務一覧（詳細）＝業務タスク一覧: `/business/{bizId}/tasks`（作成/編集/削除）
- 業務タスク詳細: `/business/{bizId}/tasks/{taskId}`（業務要件カード内で関連システム要件をバッジ表示。スクロール往復を削減）
- 業務タスク編集: `/business/{bizId}/tasks/{taskId}/edit`（業務要件・システム要件を含む編集。業務要件から関連システム要件を選択可能）
- 業務タスク新規作成: `/business/{bizId}/tasks/create`（タスク＋業務要件の一括登録。業務要件から既存システム要件を紐づけ可能）
- AI修正指示（デモ）: `/business/{bizId}/tasks/ai-order`（ラフ入力→差分候補の提示。LLM連携は将来）

#### 3.3.2 システム領域→システム機能（カタログ中心）

- システム領域一覧: `/system-domains`（一覧/検索）
- システム領域 作成/編集/削除: `/system-domains/create`, `/system-domains/{systemDomainId}/edit`
- システム機能一覧（領域内）: `/system-domains/{systemDomainId}`（一覧/フィルタ/削除）
- システム機能 新規作成: `/system-domains/{systemDomainId}/create`（システム要件と紐づけて登録）
- システム機能 詳細: `/system-domains/{systemDomainId}/{srfId}`（設計項目/コード参照/関連システム要件）
- システム機能 編集: `/system-domains/{systemDomainId}/{srfId}/edit`

#### 3.3.3 概念辞書（育てる）

- 概念一覧: `/ideas`
- 概念 新規作成: `/ideas/create`
- 概念 詳細/編集: `/ideas/{conceptId}` / `/ideas/{conceptId}/edit`
- 概念の統合/分割: UI導線はあるが、統合・分割の実処理は将来（1.3）

### 3.4 参照・補助画面

- ダッシュボード: `/dashboard`（サンプル。将来：レビュー待ち変更要求、要確認、クイックアクション）
- 照会: `/query`（サンプル。将来：根拠付き横断検索）
- ベースライン履歴: `/baseline`（準備中。将来：版間差分、取り込み変更要求、適用履歴）
- エクスポート: `/export`（準備中。将来：5章のClaude Code連携形式で出力）
- 設定: `/settings`（一部設定は将来）

---

## 4. 機能体系と実装状況（Next.js現行）

本章では、2章までの運用設計（変更要求中心）に合わせて機能体系を整理し、現行Next.js実装で「実装済/部分実装/未実装」が判別できる形で一覧化する。

### 4.1 実装状況の定義

| 実装状況 | 定義 |
|----------|------|
| 実装済 | 画面があり、主要操作が実データ（Supabase）で成立している |
| 部分実装 | 画面はあるが、モックデータ/静的表示/一部機能が未である |
| 未実装 | 画面・永続化・連携のいずれも未で、PRD上の要求のみがある |

### 4.2 実装状況一覧（画面/機能別）

#### 4.2.0 抜本方針（客観的提案）

> **2026-01-20更新**: 変更要求機能はPhase 5.6完了により「部分提供中」に昇格。DB連携・受入条件確認状態更新が運用可能な状態。

変更要求/版管理は段階的に実装を進めている。現行の提供方針は以下のとおり。

- 提供中の価値は「意図の正本（ベースライン仕様の整備）」にある（4.2.2）
- 変更要求（4.2.1）は「部分提供中」として、起票・編集・受入条件確認が運用可能
- 版管理（4.2.3）は「準備中（UIのみ）」のまま
- 変更要求/版管理の実装は、フル機能ではなく「薄いスライス」を優先する（KISS / YAGNI）

薄いスライス（まず運用できる状態を作る）:

| カテゴリ | 先にやる（最小） | 後回し（YAGNI） | 実装状況 |
|----------|------------------|------------------|----------|
| 変更要求 | 永続化（起票/編集/状態/優先度/担当）、履歴（誰がいつ何を確定したか） | 承認フロー、権限、複数案件横断 | **実装済** |
| 影響範囲 | 手動で「業務/タスク/要件/概念/システム機能/ファイル」を確定できるUI + 根拠メモ | AI自動抽出/クラスタリング/確信度最適化 | **実装済**（影響範囲選択UI・確定UI・北極星KPI表示） |
| 受入 | 受入条件ごとの確認状態（未確認/OK/NG）と確認根拠を保持（1.1.1） | テスト管理ツールの詳細連携 | **実装済** |
| 版管理 | 変更要求の「適用履歴」と「スナップショット（何を取り込んだか）」を残す | 版間差分の完全自動化、複数版同時適用、マージ戦略 | 未実装 |
| 指示パッケージ | コーディングエージェント向けの最小出力（影響範囲/変更内容/受入条件/根拠） | 5章の完全エクスポート、コード本文の自動取り込み | 未実装 |

#### 4.2.1 変更要求（イベント）

> **2026-01-21更新**: Phase 5.7完了により、影響範囲選択UI・確定UI・北極星KPI達成状況表示が実装済みです。影響分析（AI自動抽出）は将来実装予定。

| 機能 | ルート | データ | 実装状況 | 備考 |
|------|--------|--------|----------|------|
| 変更要求一覧 | `/tickets` | Supabase | 実装済 | 一覧/検索/フィルタ/削除 |
| 変更要求 起票 | `/tickets/create` | Supabase | 実装済 | フォーム入力・DB保存・自動採番 |
| 変更要求 詳細 | `/tickets/{id}` | Supabase | 実装済 | 基本情報/影響範囲/受入条件確認状況表示 |
| 変更要求 編集 | `/tickets/{id}/edit` | Supabase | 実装済 | 基本情報の編集/DB更新 |
| 受入条件の確認状態更新 | `/tickets/{id}` | Supabase | 実装済 | **変更要求チケット内で受入条件ごとの確認状態（未確認/OK/NG）・確認者・確認日時・根拠を管理する機能。北極星KPI（全確認済みOK）の判定に使用する。1.1.1で定義された「確認状態」を変更要求単位で版管理する** |
| 影響範囲選択 | `/tickets/{id}`, `/tickets/create`, `/tickets/{id}/edit` | Supabase | **実装済** | 業務要件・システム要件の階層選択UI（ビジネス領域→業務タスク→業務要件、システム領域→システム機能→システム要件）。選択時に `change_request_impact_scopes` へ保存し、選択要件の受入条件を `change_request_acceptance_confirmations` へ自動登録。ImpactScopeSelectorコンポーネントで実装 |
| 影響範囲の確定 | `/tickets/{id}` | Supabase | **実装済** | 確定ボタンで影響範囲をconfirmed状態に変更。confirmed_by/confirmed_atを記録。確定済みは編集不可にする。TicketImpactCardコンポーネントで個別確定・一括確定が可能 |
| 影響分析（AI） | `/tickets/{id}` | - | 未実装 | ボタンはあるが分析・根拠生成は未 |
| ベースライン反映（版適用） | `/tickets/{id}` | - | 未実装 | 反映ボタンはあるが、版適用の実処理/履歴は未 |

##### データアクセス層（実装済み）

変更要求機能を支えるリポジトリ層が実装済み：

| ファイル | 関数数 | 主な機能 |
|---------|-------|----------|
| `lib/data/change-requests.ts` | 9 | 変更要求のCRUD、ステータス/優先度フィルタ |
| `lib/data/impact-scopes.ts` | 7 | 影響範囲の追加/更新/削除、確定処理（confirmImpactScopeでconfirmed_by/confirmed_atを記録） |
| `lib/data/acceptance-confirmations.ts` | 9 | 確認状態の更新、北極星KPI判定用の完了状態取得 |

##### UIコンポーネント（実装済み）

| コンポーネント群 | 役割 |
|-----------------|------|
| `components/tickets/acceptance-confirmation-*.tsx` | 受入条件確認パネル（一覧表示/状態更新/一括確認） |
| `components/tickets/impact-scope-selector.tsx` | 影響範囲選択UI（業務要件・システム要件の階層選択、タブ切り替え、選択済み表示） |
| `components/tickets/ticket-impact-card.tsx` | 影響範囲確定UI（確定ボタン、confirmed状態表示、confirmed_by/confirmed_at表示、一括確定） |
| `components/tickets/change-request-*.tsx` | 変更要求一覧テーブル（ヘッダー/ツールバー/行/アクション） |
| `hooks/use-acceptance-*.ts` | 受入条件確認のカスタムフック |
| `hooks/use-change-request*.ts` | 変更要求のカスタムフック |

#### 4.2.2 ベースライン仕様（意図の正本）

| 機能 | ルート | データ | 実装状況 | 備考 |
|------|--------|--------|----------|------|
| 業務一覧 | `/business` | Supabase | 実装済 | 一覧/検索/削除 |
| 業務 作成 | `/business/create` | Supabase | 実装済 | 自動採番して作成 |
| 業務 編集 | `/business/{bizId}/edit` | Supabase | 実装済 |  |
| 業務タスク一覧 | `/business/{bizId}/tasks` | Supabase | 実装済 | 一覧/検索/削除 |
| 業務タスク 作成 | `/business/{bizId}/tasks/create` | Supabase | 実装済 | タスク＋業務要件の一括登録 |
| 業務タスク 詳細 | `/business/{bizId}/tasks/{taskId}` | Supabase | 実装済 | 業務要件/関連システム要件の参照 |
| 業務タスク 編集 | `/business/{bizId}/tasks/{taskId}/edit` | Supabase | 実装済 | タスク基本情報＋要件（同期保存） |
| 受入条件（要件に保持） | 上記の要件編集 | Supabase | 実装済 | 業務要件/システム要件に構造化配列で保持（Phase 1: jsonb配列へ段階移行） |
| AI修正指示（差分候補） | `/business/{bizId}/tasks/ai-order` | 静的 | 部分実装 | LLM連携なしのデモ |
| 概念辞書一覧 | `/ideas` | Supabase | 実装済 | 一覧/検索/削除 |
| 概念 作成 | `/ideas/create` | Supabase | 実装済 | 自動採番して作成 |
| 概念 詳細/編集 | `/ideas/{conceptId}` / `/ideas/{conceptId}/edit` | Supabase | 実装済 |  |
| 概念の統合/分割 | `/ideas/{conceptId}` | - | 未実装 | ボタン導線のみ |
| システム領域一覧 | `/system-domains` | Supabase | 実装済 | 一覧/検索/削除 |
| システム領域 作成 | `/system-domains/create` | Supabase | 実装済 | 作成 |
| システム領域 編集 | `/system-domains/{systemDomainId}/edit` | Supabase | 実装済 | 編集 |
| システム機能一覧（領域内） | `/system-domains/{systemDomainId}` | Supabase | 実装済 | 検索/フィルタ/削除 |
| システム機能 作成 | `/system-domains/{systemDomainId}/create` | Supabase | 実装済 | システム要件作成＋業務要件とのリンク付け＋構造化された受入条件入力 |
| システム機能 詳細/編集 | `/system-domains/{systemDomainId}/{srfId}` / `/system-domains/{systemDomainId}/{srfId}/edit` | Supabase | 実装済 | 設計項目/コード参照/ステータス管理/システム要件CRUD（追加/編集/削除）/構造化された受入条件表示・編集 |

- システム要件のCRUD（追加/編集/削除）は、システム機能の詳細/編集画面（`/system-domains/{systemDomainId}/{srfId}/edit`）で行う

#### 4.2.3 照会・可視化・出力・設定（横断）

| 機能 | ルート | データ | 実装状況 | 備考 |
|------|--------|--------|----------|------|
| ダッシュボード | `/dashboard` | 混在（Supabase/静的） | 部分実装 | ヘルススコア集計は実装、他はサンプル |
| 照会（自然言語検索） | `/query` | 静的 | 部分実装 | サンプル表示。検索/根拠生成は将来 |
| ベースライン履歴 | `/baseline` | 静的 | 部分実装 | 一覧のみ。版詳細/差分は未 |
| グラフビュー | - | - | 未実装 | 画面・データともに未 |
| エクスポート（画面） | `/export` | - | 部分実装 | UIのみ。5章形式の出力は未 |
| プロジェクト設定 | `/settings` | - | 部分実装 | UIはあるが永続化は未（将来） |
| LLM設定 | `/settings/llm` | - | 部分実装 | UIはあるが接続/保存は未 |
| 通知設定 | `/settings/notification` | - | 部分実装 | UIはあるが通知配信は未 |
| 受入条件lint | - | - | 部分実装 | 簡易lint（曖昧語検知）のみ |
| 要確認リンク管理 | - | - | 未実装 | 判定・重大度付与・一括消化は未 |

---

## 5. エクスポート仕様（Claude Code連携）

本章は、本ツールの正本をClaude Codeが参照できる形式で出力する仕様を定義する。

詳細な仕様については [エクスポート仕様](./request/export-specification.md) を参照すること。

## 6. 技術アーキテクチャ（影響分析AI）

本章は、変更要求に対する影響分析を自動化するAIシステムのアーキテクチャを定義する。
前提として **Cloud Runにデプロイして運用する**（非同期実行・ステートレス・Secrets管理などを含む）ことを採用する。
実装/運用上の詳細（非同期実行モデル、冪等性、Secrets、ネットワーク、監視、コスト設計など）はPRDには書かず、下記の設計/仕様に集約する。

- 詳細仕様（将来拡張含む）: [技術アーキテクチャ](./request/architecture-specification.md)
- 詳細設計: [技術アーキテクチャ](./design/ai-impact-analysis.md)
