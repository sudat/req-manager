# プロダクト要件データ更新プラン

## 概要
中堅企業向け（売上高100億円規模）会計システムとして、プロダクト要件テーブルのデータを本物っぽい内容で上書きする。

## 対象
- **プロジェクトID**: `00000000-0000-0000-0000-000000000001`
- **プロジェクト名**: 新会計システムプロジェクト
- **テーブル**: `product_requirements`
- **レコードID**: `PR-00000000-0000-0000-0000-000000000001`

## 実行内容

### 手順1: Supabase MCPでUPDATE実行
以下のSQLを実行してプロダクト要件を更新する。

```sql
UPDATE product_requirements
SET
  target_users = '# ターゲットユーザー定義

## プライマリユーザー

### 1. 財務マネージャー / 経理部長
- **年齢**: 40代〜50代
- **役割**: 月次・年次決算の総括、財務報告、資金管理
- **スキルレベル**: 中級〜上級（会計ソフトウェアに習熟）
- **主要タスク**:
  - 決算スケジュール管理と進捗監視
  - 財務諸表の作成と経営層への報告
  - キャッシュフロー管理と資金繰り計画
  - 監査対応と税務申告の統括
- **期待体験**:
  - 決算処理の全体状況が一覧で把握できる
  - 異常値（未処理传票、不一致）が即座に検知できる
  - 財務分析レポートがワンクリックで出力できる

### 2. 経理担当者 / オペレーター
- **年齢**: 25代〜40代
- **役割**: 日常的な传票入力、補助元帳管理、銀行勘定調整
- **スキルレベル**: 初級〜中級（Excel操作は可能）
- **主要タスク**:
  - 仕訳传票の起票と承認フロー処理
  - 売掛金・買掛金の元帳管理
  - 経費処理と請求書照合
  - 固定資産台帳のメンテナンス
  - 試算表・各種補助表の出力
- **期待体験**:
  - 传票入力がキーボード操作のみで完結する
  - 定型的な仕訳がテンプレート化されている
  - 入力エラーが即座にフィードバックされる
  - 前月処理との比較が容易

### 3. 部門別経理担当
- **年齢**: 30代〜50代
- **役割**: 各事業部門の予算管理・経費精査
- **スキルレベル**: 初級〜中級
- **主要タスク**:
  - 部門別予算実績の確認
  - 経費承認処理
  - 部門別損益の把握
- **期待体験**:
  - 予算実績対比表が視覚的に理解できる
  - 承認画面がスマートフォンでも操作可能

## セカンダリユーザー

### 4. 経営層（CFO / 経営企画室）
- **年齢**: 40代〜60代
- **役割**: 財務指標の監視、経営判断
- **スキルレベル**: 初級（閲覧が主）
- **主要タスク**:
  - 財務ダッシュボードの閲覧
  - キャッシュフローと利益状況の確認
  - 予算差異の把握
- **期待体験**:
  - 財務状況がKPIグラフで一目でわかる
  - ドリルダウンで詳細に遡れる
  - アラートがメール/通知で届く

## ユーザー環境想定

- **デバイス**: Windows PC（会社支給）、iPad（経営層）、スマートフォン（承認時）
- **ブラウザ**: Chrome / Edge（最新2バージョン）
- **インターネット**: 安定した社内LAN、一部在宅勤務（VPN経由）
- **利用時間**: 平日9:00-18:00（決算期は残業あり）
- **同時アクセス**: 5〜30ユーザー（中堅企業規模）
- **データ量**: 传票数 3,000〜10,000件/月、補助元帳データ 5〜10年分保持'::text,

  experience_goals = '# ユーザー体験目標

## 1. 業務効率化

### 1.1 入力効率の向上
- **传票入力時間**:
  - 単純仕訳：30秒/件（現行：90秒）→ 67%削減
  - 複合仕訳：90秒/件（現行：3分）→ 50%削減
- **テンプレート活用**:
  - よく使う仕訳パターン（経費支払、売掛金回収等）のテンプレート登録
  - 定期仕訳（家賃、リース料等）の自動起票機能
- **キーボード操作**:
  - Tabキーによる項目移動
  - ショートカットキー（保存：Ctrl+S、承認：Ctrl+Enter）
  - 計算式入力支援（科目コードから科目名自動補完）

### 1.2 承認フローの最適化
- **承認待ち件数**:
  - ダッシュボードでの未処理件数表示
  - 期限切れ案件のアラート表示
- **一括処理**:
  - 複数件の一括承認（金額 threshold 以下のみ）
  - 条件付き自動承認（定額経費など）
- **モバイル承認**:
  - スマートフォンからの簡易承認
  - 緊急時の即時対応

### 1.3 レポート出力の高速化
- **出力時間**:
  - 試算表：5秒以内（データ5万件）
  - 財務諸表：10秒以内
  - 分析レポート：30秒以内
- **出力形式**:
  - PDF（印刷用）、Excel（加工用）、CSV（データ連携用）
  - スケジュール配信（毎月5日に自動送信）

## 2. ミス削減

### 2.1 入力バリデーション
- **リアルタイムチェック**:
  - 借貸一致の即時検証
  - 予算超過の警告表示（部門予算がある場合）
  - 重複传票の検知（同一日付・同一金額・同一取引先）
- **必須項目制御**:
  - 消費税区分の自動設定（税込/税別/不課税）
  - 課税事業者の判定自動化

### 2.2 照合機能
- **銀行勘定調整**:
  - 銶行口座データの自動取込（OFX / CSV / API連携）
  - 未達取引の自動マッチング
  - 差異の自動抽出
- **買掛金照合**:
  - 請求書データとの突合
  - 支払予定表の自動作成

### 2.3 承認プロセスによる品質保証
- **二重承認**:
  - 金額100万円超：経理部長 + CFO
  - 異常勘定科目使用：財務マネージャーの確認必須
- **履歴追跡**:
  - 作成者・承認者の記録
  - 修正履歴の完全保存（変更前/変更後）

## 3. リアルタイム可視化

### 3.1 財務ダッシュボード
- **KPI表示**:
  - 当月売上高・経費・利益（前年同月比・前月比）
  - キャッシュフロー残高
  - 予算達成率（部門別）
- **グラフ表示**:
  - 売上高・経費のトレンド（12ヶ月推移）
  - 部門別損益のパイチャート
  - 目標対比のプログレスバー
- **ドリルダウン**:
  - 概要 → 試算表 → 传票明細の階層遷移

### 3.2 決算進捗管理
- **ステータス表示**:
  - 传票入力完了率
  - 各種調整未処理件数
  - 承認待ち件数
- **タイムライン**:
  - 決算スケジュールのカレンダー表示
  - 遅延タスクのアラート
- **タスク割当**:
  - 担当者別の未処理タスク一覧

## 定量的目標（3ヶ月後の達成目標）

| 指標 | 現行 | 目標 | 改善率 |
|------|------|------|--------|
| 传票入力時間 | 90秒/件 | 30秒/件 | 67%削減 |
| 月次決算期間 | 15営業日 | 7営業日 | 53%短縮 |
| 入力エラー率 | 3% | 0.5% | 83%削減 |
| 承認処理時間 | 2.5日 | 1日 | 60%短縮 |
| レポート出力時間 | 60秒 | 10秒 | 83%短縮 |'::text,

  quality_goals = '# 品質目標

## 1. セキュリティ

### 1.1 認証・認可
- **認証方式**: Supabase Authによる多要素認証（MFA）
- **認可モデル**: RBAC（財務マネージャー、経理担当者、閲覧のみ）
- **監査ログ**: 全操作のログ記録、7年間保存

### 1.2 データ保護
- **暗号化**: AES-256（保存時）、TLS 1.3（通信時）
- **バックアップ**: 毎日自動バックアップ、リテンション90日
- **RTO**: 2時間以内、**RPO**: 24時間以内

### 1.3 コンプライアンス
- **法定保存期間**: 传票7年、財務諸表10年
- **会計監査対応**: 修正履歴の完全保存

## 2. パフォーマンス

| 操作 | 目標 | 95パーセンタイル | 許容値 |
|------|------|------------------|--------|
| ページ初期ロード | 2秒 | 3秒 | 5秒 |
| 传票一覧表示（100件） | 0.5秒 | 1秒 | 2秒 |
| 传票保存 | 0.5秒 | 1秒 | 2秒 |
| 試算表出力（5万件） | 3秒 | 5秒 | 10秒 |
| ダッシュボード表示 | 1秒 | 2秒 | 3秒 |

### 2.2 同時アクセス対応
- **同時ユーザー数**: 100ユーザー
- **同時传票入力**: 50件/分（繁忙期ピーク）

## 3. 可用性
- **目標稼働率**: 99.9%（年間8.7時間のダウンタイム許容）
- **計画メンテナンス**: 毎月第2日曜 2:00-6:00

## 4. テスト品質
- **ユニットテスト**: 80%以上
- **E2Eテスト**: クリティカルパス100%網羅'::text,

  design_system = '# デザインシステム

## 1. デザイン哲学
- **信頼感（Trustworthiness）**: 青・グレー系を基調、一貫性のあるレイアウト
- **情報の整理（Clarity）**: データ密度が高くても読みやすい情報設計
- **業務効率（Efficiency）**: 頻繁に使用する機能へのアクセスを最短に

## 2. 視覚的言語

### カラーシステム
- **Primary Blue**: #0066CC（信頼・誠実）
- **Success Green**: #10B981（承認・完了）
- **Error Red**: #EF4444（エラー・否決）
- **Warning Yellow**: #F59E0B（予算超過警告）

### タイポグラフィ
- **Sans-serif**: Inter, Noto Sans JP
- **Mono**: JetBrains Mono（数字・金額表示）
- **フォントサイズ**: H1(32px) / H2(24px) / Body(14px) / Caption(11px)

### 3. コンポーネントシステム
- **ベース**: shadcn/ui（Button, Input, Table, Card, Dialog, Toast等）
- **カスタム**: AmountDisplay, JournalTable, StatusBadge, ProgressBar

### 4. レイアウトパターン
- **サイドバー**: 幅240px（折りたたみ時64px）
- **メインコンテンツ**: 最大幅1440px、パディング32px
- **テーブル**: 金額は右揃え・等幅フォント'::text,

  ux_guidelines = '# UXガイドライン

## 1. 入力設計
- **テンプレート活用**: よく使う仕訳パターンを登録
- **自動補完**: 科目コード・取引先の自動補完
- **キーボード操作**: Tabで移動、Ctrl+Sで保存、Ctrl+Enterで承認
- **即時バリデーション**: フォーカスアウト時にエラー表示

## 2. 承認フロー
- **情報の階層化**: 概要 → 明細 → 履歴
- **アクション配置**: 画面右下に固定（承認・差戻し・否決）
- **一括承認**: 閾値以下の金額を一括承認可能

## 3. 検索・フィルタリング
- **全文検索**: 摘要・取引先・科目名を横断検索
- **詳細検索**: 期間・金額範囲・科目・部門の複数条件
- **キーボードショートカット**: Ctrl+Kで検索ボックスにフォーカス

## 4. エラーハンドリング
- **具体的なメッセージ**: 何が起きたか・なぜ・どうすればいいか
- **インラインエラー**: 各フィールドの下に赤文字で表示
- **回復可能なエラー**: 再試行ボタン・自動リトライ

## 5. キーボードショートカット
- **Ctrl+S**: 保存
- **Ctrl+Enter**: 承認
- **Ctrl+K**: 検索
- **Escape**: キャンセル'::text,

  tech_stack_profile = '{
  "frontend": {
    "framework": "Next.js 16",
    "language": "TypeScript",
    "ui_library": "shadcn/ui",
    "styling": "Tailwind CSS"
  },
  "backend": {
    "platform": "Supabase",
    "database": "PostgreSQL 15",
    "auth": "Supabase Auth"
  },
  "testing": {
    "unit_testing": {
      "framework": "Vitest",
      "library": "Testing Library"
    },
    "e2e_testing": {
      "framework": "Playwright",
      "runner": "Playwright MCP (WSL環境)"
    }
  },
  "development": {
    "package_manager": "Bun",
    "runtime": "Bun 1.0+",
    "environment": "WSL2 (Linux)"
  }
}'::jsonb,

  coding_conventions = '{
  "typescript": {
    "strict_mode": true,
    "naming_conventions": {
      "components": "PascalCase",
      "functions": "camelCase",
      "constants": "SCREAMING_SNAKE_CASE"
    }
  },
  "react": {
    "prefer_function_components": true,
    "hooks_rules": "Follow Rules of Hooks strictly"
  },
  "nextjs": {
    "routing": "App Router",
    "server_components": "Use by default"
  },
  "styling": {
    "tailwind": "Utility-first approach",
    "shadcn_ui": "Use as base, customize via variants"
  }
}'::jsonb,

  forbidden_choices = '{
  "frameworks_and_libraries": {
    "avoid": ["jQuery", "Angular", "Redux", "Material-UI"],
    "reason": "Maintain consistency with existing tech stack"
  },
  "backend_alternatives": {
    "avoid": ["Firebase", "AWS Amplify", "Custom REST API"],
    "reason": "Leverage Supabase as the backend platform"
  },
  "code_patterns": {
    "avoid": ["God components", "Prop drilling", "any type", "Magic numbers"],
    "reason": "Maintain code quality and readability"
  },
  "security": {
    "avoid": ["Hard-coded secrets", "Disabled RLS", "SQL injection"],
    "reason": "Protect user data and prevent breaches"
  }
}'::jsonb,

  updated_at = NOW()
WHERE id = 'PR-00000000-0000-0000-0000-000000000001';
```

## 更新フィールド一覧

| フィールド | 内容 | 概要 |
|-----------|------|------|
| `target_users` | ターゲットユーザー定義 | 財務マネージャー・経理担当者・経営層のペルソナ |
| `experience_goals` | ユーザー体験目標 | 業務効率化・ミス削減・リアルタイム可視化 |
| `quality_goals` | 品質目標 | セキュリティ・パフォーマンス・可用性 |
| `design_system` | デザインシステム | カラーシステム・タイポグラフィ・コンポーネント |
| `ux_guidelines` | UXガイドライン | 入力設計・承認フロー・エラーハンドリング |
| `tech_stack_profile` | 技術スタック | Next.js 16 / Supabase / Playwright MCP |
| `coding_conventions` | コーディング規約 | TypeScript / React / Next.js規約 |
| `forbidden_choices` | 禁止事項 | 使用禁止のライブラリ・パターン |

## 検証手順

1. **データ更新確認**
   ```bash
   # Supabase MCPで更新後のデータを確認
   SELECT id, project_id, target_users, tech_stack_profile
   FROM product_requirements
   WHERE id = 'PR-00000000-0000-0000-0000-000000000001';
   ```

2. **画面表示確認**
   - `http://localhost:3002/product-requirement` にアクセス
   - 各タブ（基本情報、体験目標、品質目標、デザイン・UX、技術スタック）の内容が表示されることを確認
   - Markdown形式の内容が正しくレンダリングされていることを確認
   - JSON形式のフィールド（tech_stack_profile等）が正しく表示されることを確認

## 注意事項
- 既存のデータは完全に上書きされます
- `project_id` は変更しません
- JSONフィールド（`tech_stack_profile`, `coding_conventions`, `forbidden_choices`）は `::jsonb` キャストを使用します
