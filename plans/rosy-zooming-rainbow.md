# 変更要求機能 統合テスト（Phase 6）実装計画

## 概要

Phase 1-5で実装した変更要求機能の統合テストを行います。**新規実装は不要**であり、既存の実装が正しく動作することを確認するフェーズです。

## 難易度

```
難易度: ★☆☆
根拠: 検証スクリプト1ファイル、チェックリスト更新、既存機能への影響なし
リスク: Playwright MCPでの画面操作確認のみ
```

---

## 検証項目

### 1. エンドツーエンドフロー確認
- 変更要求の起票 → 影響範囲の確定 → 受入条件確認 → 完了判定のフロー
- 北極星KPI（全受入条件が確認済みOK）の判定が正しく動作する
- 受入条件がNGの場合、変更要求が「判定不能」となる

### 2. データ整合性確認
- 受入条件定義（ベースライン仕様）に確認状態が混在していない
- 変更要求ごとに独立した確認状態が保持されている
- 同一受入条件が複数の変更要求で異なる確認状態を持てる

### 3. 既存機能への影響確認
- 業務要件の編集が正常に動作する
- システム要件の編集が正常に動作する
- 既存の受入条件データが失われていない

---

## 作業内容

### 1. E2Eテスト（Playwright MCP）

#### シナリオ1: 変更要求のライフサイクル
1. 一覧画面から「変更要求を起票」をクリック
2. タイトル・背景を入力
3. 影響範囲を選択（業務要件 or システム要件）
4. 作成後、詳細ページで受入条件が自動登録されていることを確認
5. 受入条件を1件ずつ「確認済み(OK)」に変更
6. 確認済み率がリアルタイムで更新されることを確認
7. ステータスを「適用済」に変更して完了

#### シナリオ2: 北極星KPI判定
1. CR-001の詳細ページに遷移
2. 現在の確認状況サマリーを確認
3. すべての受入条件を「確認済み(OK)」に変更
4. 確認済み率が100%になることを確認

#### シナリオ3: 受入条件NG時の挙動
1. 新規変更要求を作成
2. 1件目の受入条件を「確認済み(NG)」に変更
3. エビデンス入力フォームが表示されることを確認
4. エビデンスを入力して保存
5. ステータスがNGになっていることを確認

### 2. データ整合性検証（Supabase MCP）

#### 検証1: 受入条件定義の分離
- `business_requirements.acceptance_criteria_json` に `status`/`verified_by` が含まれていないことを確認
- `system_requirements.acceptance_criteria_json` に `status`/`verified_by` が含まれていないことを確認

#### 検証2: 変更要求ごとの独立確認状態
- `change_request_acceptance_confirmations` テーブルで、同一 `acceptance_criterion_id` が異なる `change_request_id` で異なる `status` を持つことを確認

#### 検証3: 既存データの保持
- `business_requirements` の行数が53件以上であることを確認
- `system_requirements` の行数が56件以上であることを確認

### 3. 既存機能への影響確認（Playwright MCP）

#### 検証1: 業務要件編集
1. `/business` に遷移
2. 任意の業務要件を選択して「編集」をクリック
3. 受入条件入力コンポーネントが正しく表示されることを確認
4. 条件を追加して保存

#### 検証2: システム要件編集
1. `/system-domains` に遷移
2. 任意のシステム領域 → システム機能 → 編集
3. 受入条件入力コンポーネントが正しく表示されることを確認

### 4. チェックリスト更新

検証完了後、`docs/checklists/active/2026-01-20-change-request-feature.md` の Phase 6 セクションを更新します。

---

## 実行順序

1. **データ整合性検証**（Supabase MCP）
2. **既存機能確認**（Playwright MCP）
3. **E2Eテスト**（Playwright MCP）
4. **チェックリスト更新**

---

## 関連ファイル

### 検証対象
- `/app/tickets/page.tsx` - 一覧ページ
- `/app/tickets/create/page.tsx` - 作成ページ
- `/app/tickets/[id]/page.tsx` - 詳細ページ
- `/app/tickets/[id]/edit/page.tsx` - 編集ページ
- `/app/business/[id]/edit/page.tsx` - 業務要件編集
- `/app/system-domains/[id]/[srfId]/edit/page.tsx` - システム要件編集
- `/components/tickets/acceptance-confirmation-panel.tsx` - 受入条件確認パネル
- `/lib/data/acceptance-confirmations.ts` - 北極星KPI判定ロジック

### 更新対象
- `/docs/checklists/active/2026-01-20-change-request-feature.md` - チェックリスト

---

## 成功基準

- [ ] すべてのE2Eシナリオが正常に完了する
- [ ] データ整合性検証のすべての項目がパスする
- [ ] 既存機能（業務要件・システム要件編集）が正しく動作する
- [ ] 北極星KPIの判定が正しく動作する
- [ ] チェックリストの Phase 6 が完了状態になる
